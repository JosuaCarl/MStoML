<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>skripts.FIA.FIA &mdash; Community composition VAE + Inference 0.9 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=049aceee"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Community composition VAE + Inference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">skripts</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Community composition VAE + Inference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">skripts.FIA.FIA</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for skripts.FIA.FIA</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Methods for Flow-injection-analysis.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># Imports</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">gc</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">psutil</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">polars</span> <span class="k">as</span> <span class="nn">pl</span>

<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>

<span class="kn">import</span> <span class="nn">pyopenms</span> <span class="k">as</span> <span class="nn">oms</span>

<span class="kn">import</span> <span class="nn">scipy</span> <span class="k">as</span> <span class="nn">sci</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">find_peaks</span>
<span class="kn">from</span> <span class="nn">scipy.spatial.distance</span> <span class="kn">import</span> <span class="n">pdist</span>
<span class="kn">from</span> <span class="nn">scipy.cluster.hierarchy</span> <span class="kn">import</span> <span class="n">fcluster</span><span class="p">,</span> <span class="n">linkage</span>

<span class="kn">from</span> <span class="nn">sklearn.impute</span> <span class="kn">import</span> <span class="n">KNNImputer</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">FunctionTransformer</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">Pipeline</span>


<span class="c1">## Data</span>
<div class="viewcode-block" id="batch_download">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.batch_download">[docs]</a>
<span class="k">def</span> <span class="nf">batch_download</span><span class="p">(</span><span class="n">base_url</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_urls</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">save_directory</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Download files from a list into a directory.</span>

<span class="sd">    :param base_url: Base URL</span>
<span class="sd">    :type base_url: str</span>
<span class="sd">    :param file_urls: Individual file URLS which are appended to the base</span>
<span class="sd">    :type file_urls: list</span>
<span class="sd">    :param save_directory: Directory to save files to.</span>
<span class="sd">    :type save_directory: str</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">for</span> <span class="n">file_url</span> <span class="ow">in</span> <span class="n">file_urls</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_url</span> <span class="o">+</span> <span class="n">file_url</span><span class="p">,</span> <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">save_directory</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file_url</span><span class="p">)),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">content</span><span class="p">)</span></div>



<span class="c1"># Helpers</span>
<div class="viewcode-block" id="bits_to_bytes">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.bits_to_bytes">[docs]</a>
<span class="k">def</span> <span class="nf">bits_to_bytes</span><span class="p">(</span><span class="n">bits</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">factor</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Coverts a number of bits to a number of bytes for readability.</span>

<span class="sd">    :param bits: Number of bits to be converted</span>
<span class="sd">    :type bits: Union[float, int]</span>
<span class="sd">    :param factor: / 10**factor (e.g. use 9 for GB)</span>
<span class="sd">    :type factor: Union[float, int]</span>
<span class="sd">    :return: Number of bytes</span>
<span class="sd">    :rtype: float</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">round</span><span class="p">((</span><span class="n">bits</span> <span class="o">*</span> <span class="mf">0.125</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="o">**</span><span class="n">factor</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span></div>




<span class="c1">## Directories</span>
<div class="viewcode-block" id="build_directory">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.build_directory">[docs]</a>
<span class="k">def</span> <span class="nf">build_directory</span><span class="p">(</span><span class="n">dir_path</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build a new directory in the given path.</span>

<span class="sd">    :param dir_path: Directory path</span>
<span class="sd">    :type dir_path: str</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">dir_path</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">dir_path</span><span class="p">))</span></div>


<div class="viewcode-block" id="clean_dir">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.clean_dir">[docs]</a>
<span class="k">def</span> <span class="nf">clean_dir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete a directory or its subfolder and reconstruct the directory.</span>

<span class="sd">    :param dir_path: Directory path</span>
<span class="sd">    :type dir_path: str</span>
<span class="sd">    :param subfolder: Subfolder path, defaults to None</span>
<span class="sd">    :type subfolder: Optional[str], optional</span>
<span class="sd">    :return: Directory path</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">subfolder</span><span class="p">:</span>
        <span class="n">dir_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">subfolder</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dir_path</span></div>




<span class="c1">## Files</span>
<span class="c1">### Checking</span>
<div class="viewcode-block" id="check_ending_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.check_ending_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">check_ending_experiment</span><span class="p">(</span><span class="n">file</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether the file has a mzML or mzXML ending.</span>

<span class="sd">    :param file: Path to file</span>
<span class="sd">    :type file: str</span>
<span class="sd">    :return: Ending is mzML or mzXML</span>
<span class="sd">    :rtype: bool</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">return</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mzML&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.MzML&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mzXML&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.MzXML&quot;</span><span class="p">)</span></div>




<span class="c1">### Loading</span>
<div class="viewcode-block" id="read_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.read_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">read_experiment</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in MzXML or MzML File as a pyopenms experiment. If the file is in tabular format,</span>
<span class="sd">    assumes that is is in long form with two columns [&quot;mz&quot;, &quot;inty&quot;]</span>

<span class="sd">    :param experiment_path: Path to experiment</span>
<span class="sd">    :type experiment_path: str</span>
<span class="sd">    :param separator: Separator of data, defaults to &quot;\t&quot;</span>
<span class="sd">    :type separator: str, optional</span>
<span class="sd">    :raises ValueError: The experiment must end with a valid ending.</span>
<span class="sd">    :return: Experiment</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mzML&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.MzML&quot;</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MzMLFile</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mzXML&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.MzXML&quot;</span><span class="p">):</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MzXMLFile</span><span class="p">()</span>
        <span class="n">file</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.tsv&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
        <span class="n">exp_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span>
        <span class="n">spectrum</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">()</span>
        <span class="n">spectrum</span><span class="o">.</span><span class="n">set_peaks</span><span class="p">(</span> <span class="p">(</span><span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">exp_df</span><span class="p">[</span><span class="s2">&quot;inty&quot;</span><span class="p">])</span> <span class="p">)</span> <span class="c1"># type: ignore</span>
        <span class="n">experiment</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Invalid ending of </span><span class="si">{</span><span class="n">experiment_path</span><span class="si">}</span><span class="s1">. Must be in [&quot;.MzXML&quot;, &quot;.mzXML&quot;, &quot;.MzML&quot;, &quot;.mzML&quot;, &quot;.tsv&quot;, &quot;.csv&quot;, &quot;.txt&quot;]&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">experiment</span></div>



<div class="viewcode-block" id="load_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.load_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If no experiment is given, loads and returns it from either .mzML or .mzXML file.</span>
<span class="sd">    Collects garbage with gc.collect() to ensure space in the RAM.</span>

<span class="sd">    :param experiment: Experiment, or Path to experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param separator: Separator of data, defaults to &quot;\t&quot;</span>
<span class="sd">    :type separator: str, optional</span>
<span class="sd">    :return: Experiment</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">experiment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="load_experiments">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.load_experiments">[docs]</a>
<span class="k">def</span> <span class="nf">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">file_ending</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_load</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a batch of experiments.</span>

<span class="sd">    :param experiments: Experiments, either described by a list of paths or one path as base directory,</span>
<span class="sd">    or an existing experiment.</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param file_ending: Ending of experiment file, defaults to None</span>
<span class="sd">    :type file_ending: Optional[str], optional</span>
<span class="sd">    :param separator: Separator of data, defaults to &quot;\t&quot;</span>
<span class="sd">    :type separator: str, optional</span>
<span class="sd">    :param data_load: Load the data or just combine the base string to a list of full filepaths, defaults to True</span>
<span class="sd">    :type data_load: bool, optional</span>
<span class="sd">    :return: Experiments</span>
<span class="sd">    :rtype: Sequence[Union[oms.MSExperiment,str]]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_ending</span><span class="p">:</span>
            <span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span> <span class="k">if</span> <span class="n">check_ending_experiment</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">data_load</span><span class="p">:</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">)</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">experiments</span></div>



<div class="viewcode-block" id="load_name">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.load_name">[docs]</a>
<span class="k">def</span> <span class="nf">load_name</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">alt_name</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the name of an experiment.</span>

<span class="sd">    :param experiment: Experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param alt_name: Alternative Name if none is found, defaults to None</span>
<span class="sd">    :type alt_name: Optional[str], optional</span>
<span class="sd">    :param file_ending: Ending of experiment file, defaults to None</span>
<span class="sd">    :type file_ending: Optional[str], optional</span>
<span class="sd">    :raises ValueError: Raises error if no file name is found and no alt_name is given.</span>
<span class="sd">    :return: Name of experiment or alternative name</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">experiment</span><span class="o">.</span><span class="n">getLoadedFilePath</span><span class="p">():</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">getLoadedFilePath</span><span class="p">())</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">alt_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">alt_name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No file path found in experiment. Please provide alt_name.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_names_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.load_names_batch">[docs]</a>
<span class="k">def</span> <span class="nf">load_names_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If no experiment is given, loads and returns it from either .mzML or .mzXML file.</span>

<span class="sd">    :param experiments: Experiments</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param file_ending: Ending of experiment file, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :return: List of experiment names</span>
<span class="sd">    :rtype: List[str]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file_ending</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">load_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">experiments</span><span class="p">))</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">load_name</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">experiments</span><span class="p">))</span> <span class="k">if</span> <span class="n">check_ending_experiment</span><span class="p">(</span><span class="n">file</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiments</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">load_name</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">)]</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">load_name</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">))]</span></div>

    

<div class="viewcode-block" id="load_fia_df">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.load_fia_df">[docs]</a>
<span class="k">def</span> <span class="nf">load_fia_df</span><span class="p">(</span><span class="n">data_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">separator</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">data_load</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a Flow injection analysis dataframe, defining important properties.</span>

<span class="sd">    :param data_dir: Data directory</span>
<span class="sd">    :type data_dir: str</span>
<span class="sd">    :param file_ending: Ending of file</span>
<span class="sd">    :type file_ending: str</span>
<span class="sd">    :param separator: Separator for file, defaults to &quot;\t&quot;</span>
<span class="sd">    :type separator: str, optional</span>
<span class="sd">    :param data_load: Load data or only return list of experiments, defaults to True</span>
<span class="sd">    :type data_load: bool, optional</span>
<span class="sd">    :param backend: Use pandas or polars as backend, defaults to pd</span>
<span class="sd">    :type backend: _type_, optional</span>
<span class="sd">    :return: _description_</span>
<span class="sd">    :rtype: Union[pandas.DataFrame, polars.DataFrame]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading names:&quot;</span><span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">load_names_batch</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
    <span class="n">polarities</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;pos&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;neg&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading experiments:&quot;</span><span class="p">)</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">,</span> <span class="n">separator</span><span class="o">=</span><span class="n">separator</span><span class="p">,</span> <span class="n">data_load</span><span class="o">=</span><span class="n">data_load</span><span class="p">)</span>
    <span class="n">fia_df</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">samples</span><span class="p">,</span> <span class="n">polarities</span><span class="p">,</span> <span class="n">experiments</span><span class="p">])</span>
    <span class="n">fia_df</span> <span class="o">=</span> <span class="n">fia_df</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    <span class="n">fia_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="s2">&quot;polarity&quot;</span><span class="p">,</span> <span class="s2">&quot;experiment&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fia_df</span></div>



<div class="viewcode-block" id="read_mnx">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.read_mnx">[docs]</a>
<span class="k">def</span> <span class="nf">read_mnx</span><span class="p">(</span><span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read in chem_prop.tsv file from MetaNetX</span>

<span class="sd">    :param filepath: Path to file</span>
<span class="sd">    :type filepath: str</span>
<span class="sd">    :return: DataFrame</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                       <span class="n">header</span><span class="o">=</span><span class="mi">351</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;pyarrow&quot;</span>
                       <span class="p">)[[</span><span class="s2">&quot;#ID&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;formula&quot;</span><span class="p">,</span> <span class="s2">&quot;charge&quot;</span><span class="p">,</span> <span class="s2">&quot;mass&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span></div>



<div class="viewcode-block" id="read_feature_map_XML">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.read_feature_map_XML">[docs]</a>
<span class="k">def</span> <span class="nf">read_feature_map_XML</span><span class="p">(</span><span class="n">path_to_featureXML</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in feature Map from .featureXML file.</span>

<span class="sd">    :param path_to_featureXML: Path to featureXML file.</span>
<span class="sd">    :type path_to_featureXML: str</span>
<span class="sd">    :return: Feature map</span>
<span class="sd">    :rtype: pyopenms.FeatureMap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fm</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">()</span>
    <span class="n">fh</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureXMLFile</span><span class="p">()</span>
    <span class="n">fh</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">path_to_featureXML</span><span class="p">,</span> <span class="n">fm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fm</span></div>


<div class="viewcode-block" id="read_feature_maps_XML">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.read_feature_maps_XML">[docs]</a>
<span class="k">def</span> <span class="nf">read_feature_maps_XML</span><span class="p">(</span><span class="n">path_to_featureXMLs</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads in feature Maps from file</span>

<span class="sd">    :param path_to_featureXMLs: Path to featureXML file directory.</span>
<span class="sd">    :type path_to_featureXMLs: str</span>
<span class="sd">    :return: List of feature maps</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading in feature maps:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path_to_featureXMLs</span><span class="p">)):</span>
        <span class="n">fm</span> <span class="o">=</span> <span class="n">read_feature_map_XML</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path_to_featureXMLs</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
        <span class="n">feature_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feature_maps</span></div>



<div class="viewcode-block" id="define_metabolite_table">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.define_metabolite_table">[docs]</a>
<span class="k">def</span> <span class="nf">define_metabolite_table</span><span class="p">(</span><span class="n">path_to_library_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">mass_range</span><span class="p">:</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read tsv file and create list of FeatureFinderMetaboIdentCompound.</span>

<span class="sd">    :param path_to_library_file: Path to library file</span>
<span class="sd">    :type path_to_library_file: str</span>
<span class="sd">    :param mass_range: Range of m/z values</span>
<span class="sd">    :type mass_range: list</span>
<span class="sd">    :return: Metabolite table</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">metabo_table</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_library_file</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Read in </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2"> metabolites.&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="kc">False</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Charge&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Charge&quot;</span><span class="p">])))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]]</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2"> remaining after excluding zero charged metabolites.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span> 
        <span class="n">metabo_table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">oms</span><span class="o">.</span><span class="n">FeatureFinderMetaboIdentCompound</span><span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;CompoundName&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;SumFormula&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Mass&quot;</span><span class="p">],</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Charge&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))),</span> 
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;RetentionTime&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))),</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;RetentionTimeRange&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">))),</span>
                <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;IsotopeDistribution&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)))</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished metabolite table.&quot;</span><span class="p">)</span>
  
    <span class="k">return</span> <span class="n">metabo_table</span></div>




<span class="c1">### Copying</span>
<div class="viewcode-block" id="copy_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.copy_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a complete (recursive) copy of an experiment.</span>

<span class="sd">    :param experiment: Experiment</span>
<span class="sd">    :type experiment: pyopenms.MSExperiment</span>
<span class="sd">    :return: Copy of experiment.</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span></div>




<span class="c1">### Formatting</span>
<div class="viewcode-block" id="mnx_to_oms">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.mnx_to_oms">[docs]</a>
<span class="k">def</span> <span class="nf">mnx_to_oms</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turns a dataframe from MetaNetX into the required format by pyopenms for feature detection.</span>

<span class="sd">    :param df: Parameters Dataframe</span>
<span class="sd">    :type df: pandas.DataFrame</span>
<span class="sd">    :return: DataFrame with essential information.</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">df</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">df</span><span class="p">[</span><span class="s2">&quot;charge&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)),</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)))),</span>
                        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;CompoundName&quot;</span><span class="p">,</span> <span class="s2">&quot;SumFormula&quot;</span><span class="p">,</span> <span class="s2">&quot;Mass&quot;</span><span class="p">,</span> <span class="s2">&quot;Charge&quot;</span><span class="p">,</span> <span class="s2">&quot;RetentionTime&quot;</span><span class="p">,</span> <span class="s2">&quot;RetentionTimeRange&quot;</span><span class="p">,</span>
                                 <span class="s2">&quot;IsotopeDistribution&quot;</span><span class="p">])</span></div>



<div class="viewcode-block" id="join_df_by">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.join_df_by">[docs]</a>
<span class="k">def</span> <span class="nf">join_df_by</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">joiner</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">combiner</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines datframe with same &lt;joiner&gt;, while combining the name of &lt;combiner&gt; as the new index.</span>

<span class="sd">    :param df: Input DataFrame</span>
<span class="sd">    :type df: pd.DataFrame</span>
<span class="sd">    :param joiner: Indicates the column that is the criterium for joining the rows</span>
<span class="sd">    :type joiner: str</span>
<span class="sd">    :param combiner: Indicates the column that should be combined as an identifier</span>
<span class="sd">    :type combiner: str</span>
<span class="sd">    :return: Combined DataFrame</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span> 
    <span class="n">comb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">joiner</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">joiner</span><span class="p">]</span> <span class="o">==</span> <span class="n">j</span><span class="p">]</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">line</span><span class="p">[</span><span class="n">combiner</span><span class="p">]</span> <span class="o">=</span> <span class="n">query</span><span class="p">[</span><span class="n">combiner</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
        <span class="n">comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">comb</span><span class="o">.</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">line</span>
    <span class="n">comb</span> <span class="o">=</span> <span class="n">comb</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">combiner</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">comb</span></div>




<span class="c1">### Annotation</span>
<div class="viewcode-block" id="annotate_consensus_map_df">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.annotate_consensus_map_df">[docs]</a>
<span class="k">def</span> <span class="nf">annotate_consensus_map_df</span><span class="p">(</span><span class="n">consensus_map_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">mass_search_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">result_path</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                              <span class="n">mz_tolerance</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Annotate consensus map DataFrame.</span>

<span class="sd">    :param consensus_map_df: Input Consensus map DataFrame</span>
<span class="sd">    :type consensus_map_df: pd.DataFrame</span>
<span class="sd">    :param mass_search_df: Mass search DataFrame</span>
<span class="sd">    :type mass_search_df: pd.DataFrame</span>
<span class="sd">    :param result_path: Path to output results, defaults to &quot;.&quot;</span>
<span class="sd">    :type result_path: str, optional</span>
<span class="sd">    :param mz_tolerance: Tolerance of m/z deviation, defaults to 1e-05</span>
<span class="sd">    :type mz_tolerance: float, optional</span>
<span class="sd">    :return: Identified Metabolites DataFrame</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">id_df</span> <span class="o">=</span> <span class="n">consensus_map_df</span><span class="p">[[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;centroided_intensity&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">id_df</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">id_df</span><span class="o">.</span><span class="n">index</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">mz</span><span class="p">,</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mass_search_df</span><span class="p">[</span><span class="s2">&quot;exp_mass_to_charge&quot;</span><span class="p">],</span>
                              <span class="n">mass_search_df</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">],):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">id_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">id_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="nb">float</span><span class="p">(</span><span class="n">mz</span><span class="p">),</span> <span class="n">mz_tolerance</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indices</span><span class="p">:</span>
            <span class="n">id_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span>             <span class="c1"># type: ignore</span>
    <span class="n">id_df</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;;&quot;</span> <span class="ow">in</span> <span class="n">item</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">id_df</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]]</span>

    <span class="n">id_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">result_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">id_df</span></div>




<span class="c1"># Storing</span>
<div class="viewcode-block" id="store_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.store_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">store_experiment</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">experiment</span><span class="p">:</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores the experiment.</span>

<span class="sd">    :param experiment_path: Path to be stored at (must end with .mzMl or .mzXML)</span>
<span class="sd">    :type experiment_path: str</span>
<span class="sd">    :param experiment: Experiment</span>
<span class="sd">    :type experiment: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mzXML&quot;</span><span class="p">):</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">MzXMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">experiment_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mzML&quot;</span><span class="p">):</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">MzMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">MzMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">experiment_path</span><span class="p">,</span> <span class="n">experiment</span><span class="p">)</span></div>



<div class="viewcode-block" id="store_feature_maps">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.store_feature_maps">[docs]</a>
<span class="k">def</span> <span class="nf">store_feature_maps</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">out_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">names</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stores the feature maps as featureXML files.</span>

<span class="sd">    :param feature_maps: Feature Maps</span>
<span class="sd">    :type feature_maps: list</span>
<span class="sd">    :param out_dir: Output directory</span>
<span class="sd">    :type out_dir: str</span>
<span class="sd">    :param names: Names of feature maps, defaults to []</span>
<span class="sd">    :type names: Union[list[str], str], optional</span>
<span class="sd">    :param file_ending: Ending of file, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">clean_dir</span><span class="p">(</span><span class="n">out_dir</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Storing feature maps:&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">)[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature_map</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">):</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">feature_map</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;features_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">FeatureXMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.featureXML&quot;</span><span class="p">),</span> <span class="n">feature_map</span><span class="p">)</span></div>




<span class="c1">## Compound tables transformation</span>
<div class="viewcode-block" id="merge_compounds">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.merge_compounds">[docs]</a>
<span class="k">def</span> <span class="nf">merge_compounds</span><span class="p">(</span><span class="n">path_to_tsv</span><span class="p">:</span><span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Joins entries with equal Mass and SumFormula. Links CompoundName with: ;. Links rest with: ,.</span>

<span class="sd">    :param path_to_tsv: Path to TSV</span>
<span class="sd">    :type path_to_tsv: str</span>
<span class="sd">    :return: Merged compounds</span>
<span class="sd">    :rtype: pd.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path_to_tsv</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
	
    <span class="n">aggregation_functions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CompoundName&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>
    <span class="n">groupies</span> <span class="o">=</span> <span class="p">[</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;SumFormula&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Charge&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;RetentionTime&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;RetentionTimeRange&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;IsotopeDistribution&quot;</span><span class="p">]</span> <span class="p">]</span>
    <span class="n">df_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="n">groupies</span> <span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">aggregation_functions</span><span class="p">)</span>


    <span class="n">aggregation_functions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Charge&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
                                <span class="s1">&#39;RetentionTime&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
                                <span class="s1">&#39;RetentionTimeRange&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_list</span><span class="p">(),</span>
                                <span class="s1">&#39;IsotopeDistribution&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">to_list</span><span class="p">()}</span>
    <span class="n">groupies</span> <span class="o">=</span> <span class="p">[</span> <span class="n">df_new</span><span class="p">[</span><span class="s1">&#39;Mass&#39;</span><span class="p">],</span> <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;SumFormula&quot;</span><span class="p">],</span> <span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;CompoundName&quot;</span><span class="p">]]</span>
    <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span> <span class="n">groupies</span> <span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">aggregation_functions</span><span class="p">)</span>

    <span class="c1"># Exclude inorganics</span>
    <span class="n">organic_elements</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;P&quot;</span><span class="p">,</span> <span class="s2">&quot;I&quot;</span><span class="p">,</span> <span class="s2">&quot;Cu&quot;</span><span class="p">,</span> <span class="s2">&quot;Mg&quot;</span><span class="p">,</span> <span class="s2">&quot;Na&quot;</span><span class="p">,</span> <span class="s2">&quot;K&quot;</span><span class="p">,</span> <span class="s2">&quot;Zn&quot;</span><span class="p">,</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Ca&quot;</span><span class="p">,</span> <span class="s2">&quot;Co&quot;</span><span class="p">,</span> <span class="s2">&quot;Fe&quot;</span><span class="p">,</span> <span class="s2">&quot;O&quot;</span><span class="p">]</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Ac&#39;</span><span class="p">,</span> <span class="s1">&#39;Ag&#39;</span><span class="p">,</span> <span class="s1">&#39;Al&#39;</span><span class="p">,</span> <span class="s1">&#39;Am&#39;</span><span class="p">,</span> <span class="s1">&#39;Ar&#39;</span><span class="p">,</span> <span class="s1">&#39;As&#39;</span><span class="p">,</span> <span class="s1">&#39;At&#39;</span><span class="p">,</span> <span class="s1">&#39;Au&#39;</span><span class="p">,</span> <span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;Ba&#39;</span><span class="p">,</span> <span class="s1">&#39;Be&#39;</span><span class="p">,</span> <span class="s1">&#39;Bh&#39;</span><span class="p">,</span> <span class="s1">&#39;Bi&#39;</span><span class="p">,</span> <span class="s1">&#39;Bk&#39;</span><span class="p">,</span> <span class="s1">&#39;Br&#39;</span><span class="p">,</span> <span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;Ca&#39;</span><span class="p">,</span> <span class="s1">&#39;Cd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ce&#39;</span><span class="p">,</span> <span class="s1">&#39;Cf&#39;</span><span class="p">,</span> <span class="s1">&#39;Cl&#39;</span><span class="p">,</span> <span class="s1">&#39;Cm&#39;</span><span class="p">,</span> <span class="s1">&#39;Cn&#39;</span><span class="p">,</span> <span class="s1">&#39;Co&#39;</span><span class="p">,</span> <span class="s1">&#39;Cr&#39;</span><span class="p">,</span> <span class="s1">&#39;Cs&#39;</span><span class="p">,</span> <span class="s1">&#39;Cu&#39;</span><span class="p">,</span> <span class="s1">&#39;Db&#39;</span><span class="p">,</span> <span class="s1">&#39;Ds&#39;</span><span class="p">,</span> <span class="s1">&#39;Dy&#39;</span><span class="p">,</span> <span class="s1">&#39;Er&#39;</span><span class="p">,</span> <span class="s1">&#39;Es&#39;</span><span class="p">,</span> <span class="s1">&#39;Eu&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;Fe&#39;</span><span class="p">,</span> <span class="s1">&#39;Fl&#39;</span><span class="p">,</span> <span class="s1">&#39;Fm&#39;</span><span class="p">,</span> <span class="s1">&#39;Fr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ga&#39;</span><span class="p">,</span> <span class="s1">&#39;Gd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ge&#39;</span><span class="p">,</span> <span class="s1">&#39;H&#39;</span><span class="p">,</span> <span class="s1">&#39;He&#39;</span><span class="p">,</span> <span class="s1">&#39;Hf&#39;</span><span class="p">,</span> <span class="s1">&#39;Hg&#39;</span><span class="p">,</span> <span class="s1">&#39;Ho&#39;</span><span class="p">,</span> <span class="s1">&#39;Hs&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;In&#39;</span><span class="p">,</span> <span class="s1">&#39;Ir&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="s1">&#39;Kr&#39;</span><span class="p">,</span> <span class="s1">&#39;La&#39;</span><span class="p">,</span> <span class="s1">&#39;Li&#39;</span><span class="p">,</span> <span class="s1">&#39;Lr&#39;</span><span class="p">,</span> <span class="s1">&#39;Lu&#39;</span><span class="p">,</span> <span class="s1">&#39;Lv&#39;</span><span class="p">,</span> <span class="s1">&#39;Mc&#39;</span><span class="p">,</span> <span class="s1">&#39;Md&#39;</span><span class="p">,</span> <span class="s1">&#39;Mg&#39;</span><span class="p">,</span> <span class="s1">&#39;Mn&#39;</span><span class="p">,</span> <span class="s1">&#39;Mo&#39;</span><span class="p">,</span> <span class="s1">&#39;Mt&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Na&#39;</span><span class="p">,</span> <span class="s1">&#39;Nb&#39;</span><span class="p">,</span> <span class="s1">&#39;Nd&#39;</span><span class="p">,</span> <span class="s1">&#39;Ne&#39;</span><span class="p">,</span> <span class="s1">&#39;Nh&#39;</span><span class="p">,</span> <span class="s1">&#39;Ni&#39;</span><span class="p">,</span> <span class="s1">&#39;No&#39;</span><span class="p">,</span> <span class="s1">&#39;Np&#39;</span><span class="p">,</span> <span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="s1">&#39;Og&#39;</span><span class="p">,</span> <span class="s1">&#39;Os&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;Pa&#39;</span><span class="p">,</span> <span class="s1">&#39;Pb&#39;</span><span class="p">,</span> <span class="s1">&#39;Pd&#39;</span><span class="p">,</span> <span class="s1">&#39;Pm&#39;</span><span class="p">,</span> <span class="s1">&#39;Po&#39;</span><span class="p">,</span> <span class="s1">&#39;Pr&#39;</span><span class="p">,</span> <span class="s1">&#39;Pt&#39;</span><span class="p">,</span> <span class="s1">&#39;Pu&#39;</span><span class="p">,</span> <span class="s1">&#39;Ra&#39;</span><span class="p">,</span> <span class="s1">&#39;Rb&#39;</span><span class="p">,</span> <span class="s1">&#39;Re&#39;</span><span class="p">,</span> <span class="s1">&#39;Rf&#39;</span><span class="p">,</span> <span class="s1">&#39;Rg&#39;</span><span class="p">,</span> <span class="s1">&#39;Rh&#39;</span><span class="p">,</span> <span class="s1">&#39;Rn&#39;</span><span class="p">,</span> <span class="s1">&#39;Ru&#39;</span><span class="p">,</span> <span class="s1">&#39;S&#39;</span><span class="p">,</span> <span class="s1">&#39;Sb&#39;</span><span class="p">,</span> <span class="s1">&#39;Sc&#39;</span><span class="p">,</span> <span class="s1">&#39;Se&#39;</span><span class="p">,</span> <span class="s1">&#39;Sg&#39;</span><span class="p">,</span> <span class="s1">&#39;Si&#39;</span><span class="p">,</span> <span class="s1">&#39;Sm&#39;</span><span class="p">,</span> <span class="s1">&#39;Sn&#39;</span><span class="p">,</span> <span class="s1">&#39;Sr&#39;</span><span class="p">,</span> <span class="s1">&#39;Ta&#39;</span><span class="p">,</span> <span class="s1">&#39;Tb&#39;</span><span class="p">,</span> <span class="s1">&#39;Tc&#39;</span><span class="p">,</span> <span class="s1">&#39;Te&#39;</span><span class="p">,</span> <span class="s1">&#39;Th&#39;</span><span class="p">,</span> <span class="s1">&#39;Ti&#39;</span><span class="p">,</span> <span class="s1">&#39;Tl&#39;</span><span class="p">,</span> <span class="s1">&#39;Tm&#39;</span><span class="p">,</span> <span class="s1">&#39;Ts&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="s1">&#39;Xe&#39;</span><span class="p">,</span> <span class="s1">&#39;Y&#39;</span><span class="p">,</span> <span class="s1">&#39;Yb&#39;</span><span class="p">,</span> <span class="s1">&#39;Zn&#39;</span><span class="p">,</span> <span class="s1">&#39;Zr&#39;</span><span class="p">]</span>
    <span class="n">exclude_elements</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">elements</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">organic_elements</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">exclude_elements</span><span class="p">:</span>
        <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_new</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df_new</span><span class="p">[</span><span class="s2">&quot;SumFormula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">element</span><span class="p">)]</span>

    <span class="k">return</span> <span class="n">df_new</span><span class="p">[[</span><span class="s2">&quot;CompoundName&quot;</span><span class="p">,</span> <span class="s2">&quot;SumFormula&quot;</span><span class="p">,</span> <span class="s2">&quot;Mass&quot;</span><span class="p">,</span> <span class="s2">&quot;Charge&quot;</span><span class="p">,</span> <span class="s2">&quot;RetentionTime&quot;</span><span class="p">,</span> <span class="s2">&quot;RetentionTimeRange&quot;</span><span class="p">,</span> <span class="s2">&quot;IsotopeDistribution&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>




<span class="c1">## MS data transformation</span>
<span class="c1">### Binning</span>
<div class="viewcode-block" id="bin_df_stepwise">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.bin_df_stepwise">[docs]</a>
<span class="k">def</span> <span class="nf">bin_df_stepwise</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span> <span class="n">binning_var</span><span class="o">=</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">binned_var</span><span class="o">=</span><span class="s2">&quot;inty&quot;</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                    <span class="n">start</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">2000.0</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stepwise binning of a dataframe into discrete boxes.</span>

<span class="sd">    :param df: Input dataframe</span>
<span class="sd">    :type df: Union[pd.DataFrame, pl.DataFrame]</span>
<span class="sd">    :param binning_var: Binning variable, i.e. distance defining value (column in dataframe), defaults to &quot;mz&quot;</span>
<span class="sd">    :type binning_var: str, optional</span>
<span class="sd">    :param binned_var: Binned value, i.e. combined value (column in dataframe), defaults to &quot;inty&quot;</span>
<span class="sd">    :type binned_var: str, optional</span>
<span class="sd">    :param statistic: Operation to perform on binned values in a window. May take common parameters,</span>
<span class="sd">    defined by sci.stats.binned_statistic. defaults to &quot;sum&quot;</span>
<span class="sd">    :type statistic: str, optional</span>
<span class="sd">    :param start: Starting binning variable point, defaults to 0.0</span>
<span class="sd">    :type start: float, optional</span>
<span class="sd">    :param stop: Stopping binning variable point, defaults to 2000.0</span>
<span class="sd">    :type stop: float, optional</span>
<span class="sd">    :param step: Step distance along binning variable, defaults to 0.001</span>
<span class="sd">    :type step: float, optional</span>
<span class="sd">    :param backend: Backend (pandas or polars), defaults to pd</span>
<span class="sd">    :type backend: _type_, optional</span>
<span class="sd">    :return: Binned dataframe</span>
<span class="sd">    :rtype: Union[pd.DataFrame, pl.DataFrame]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="p">),</span> <span class="n">stop</span><span class="p">)</span>
    <span class="n">statistic</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bin_nrs</span> <span class="o">=</span> <span class="n">sci</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">binning_var</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="n">binned_var</span><span class="p">],</span>
                                                               <span class="n">statistic</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">))</span>
    <span class="n">bin_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">bins</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                         
    <span class="n">binned_df</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="n">bin_means</span><span class="p">,</span> <span class="s2">&quot;inty&quot;</span><span class="p">:</span> <span class="n">statistic</span><span class="p">})</span>
    <span class="n">binned_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 
    <span class="k">return</span> <span class="n">binned_df</span></div>


<div class="viewcode-block" id="bin_df_stepwise_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.bin_df_stepwise_batch">[docs]</a>
<span class="k">def</span> <span class="nf">bin_df_stepwise_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">],</span>
                          <span class="n">sample_var</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;sample&quot;</span><span class="p">,</span> <span class="n">experiment_var</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;experiment&quot;</span><span class="p">,</span>
                          <span class="n">binning_var</span><span class="o">=</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">binned_var</span><span class="o">=</span><span class="s2">&quot;inty&quot;</span><span class="p">,</span> <span class="n">statistic</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span>
                          <span class="n">start</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">stop</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">2000.0</span><span class="p">,</span> <span class="n">step</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                          <span class="n">backend</span><span class="o">=</span><span class="n">pd</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Stepwise binning of a dataframe into discrete boxes of multiple dataframes.</span>

<span class="sd">    :param experiments: Input experiments</span>
<span class="sd">    :type experiments: Union[pd.DataFrame, pl.DataFrame]</span>
<span class="sd">    :param binning_var: Binning variable, i.e. distance defining value (column in dataframe), defaults to &quot;mz&quot;</span>
<span class="sd">    :type binning_var: str, optional</span>
<span class="sd">    :param binned_var: Binned value, i.e. combined value (column in dataframe), defaults to &quot;inty&quot;</span>
<span class="sd">    :type binned_var: str, optional</span>
<span class="sd">    :param statistic: Operation to perform on binned values in a window. May take common parameters,</span>
<span class="sd">    defined by sci.stats.binned_statistic. defaults to &quot;sum&quot;</span>
<span class="sd">    :type statistic: str, optional</span>
<span class="sd">    :param start: Starting binning variable point, defaults to 0.0</span>
<span class="sd">    :type start: float, optional</span>
<span class="sd">    :param stop: Stopping binning variable point, defaults to 2000.0</span>
<span class="sd">    :type stop: float, optional</span>
<span class="sd">    :param step: Step distance along binning variable, defaults to 0.001</span>
<span class="sd">    :type step: float, optional</span>
<span class="sd">    :param backend: Backend (pandas or polars), defaults to pd</span>
<span class="sd">    :type backend: _type_, optional</span>
<span class="sd">    :return: Binned dataframe</span>
<span class="sd">    :rtype: Union[pd.DataFrame, pl.DataFrame]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">binned_dfs</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="o">.</span><span class="n">iterrows</span><span class="p">(),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">experiments</span><span class="p">)):</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">experiment_var</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">backend</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">experiment</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">long</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">binned_df</span> <span class="o">=</span> <span class="n">bin_df_stepwise</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">binning_var</span><span class="o">=</span><span class="n">binning_var</span><span class="p">,</span> <span class="n">binned_var</span><span class="o">=</span><span class="n">binned_var</span><span class="p">,</span>
                                    <span class="n">statistic</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="n">step</span><span class="p">,</span>
                                    <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">binned_dfs</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">binned_dfs</span> <span class="o">=</span> <span class="n">binned_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">binned_dfs</span> <span class="o">=</span> <span class="n">binned_dfs</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">binned_df</span><span class="p">)</span>
        <span class="n">binned_dfs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">binned_var</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">sample_var</span><span class="p">]},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">binned_dfs</span></div>




<span class="c1"># Limiting</span>
<div class="viewcode-block" id="limit_spectrum">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.limit_spectrum">[docs]</a>
<span class="k">def</span> <span class="nf">limit_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">:</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">,</span> <span class="n">mz_lower_limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">mz_upper_limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                   <span class="n">sample_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">statistic</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits the range of the Spectrum to &lt;mz_lower_limit&gt; and &lt;mz_upper_limit&gt;. </span>
<span class="sd">    Uniformly samples &lt;sample_size&gt; number of peaks from the spectrum (without replacement).</span>

<span class="sd">    :param spectrum: Input spectrum</span>
<span class="sd">    :type spectrum: pyopenms.MSSpectrum</span>
<span class="sd">    :param mz_lower_limit: Lower m/z value limit</span>
<span class="sd">    :type mz_lower_limit: Union[int, float]</span>
<span class="sd">    :param mz_upper_limit: Upper m/z value limit</span>
<span class="sd">    :type mz_upper_limit: Union[int, float]</span>
<span class="sd">    :param sample_size: Number of sampled peaks from the spectrum</span>
<span class="sd">    :type sample_size: int</span>
<span class="sd">    :param statistic: Operation to perform on binned values in a window. May take common parameters,</span>
<span class="sd">    defined by sci.stats.binned_statistic., defaults to &quot;sum&quot;</span>
<span class="sd">    :type statistic: str, optional</span>
<span class="sd">    :return: Limited and sampled spectrum</span>
<span class="sd">    :rtype: pyopenms.MSSpectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">new_spectrum</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">()</span>
    <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()</span> <span class="c1"># type: ignore</span>

    <span class="k">if</span> <span class="n">statistic</span><span class="p">:</span>
        <span class="n">statistic</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">,</span> <span class="n">bin_nrs</span> <span class="o">=</span> <span class="n">sci</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">binned_statistic</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span>
                                                                   <span class="n">statistic</span><span class="o">=</span><span class="n">statistic</span><span class="p">,</span> 
                                                                   <span class="n">bins</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span>
                                                                   <span class="nb">range</span><span class="o">=</span><span class="p">(</span><span class="n">mz_lower_limit</span><span class="p">,</span> <span class="n">mz_upper_limit</span><span class="p">))</span>
        <span class="n">statistic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">statistic</span><span class="p">)</span>
        <span class="n">bin_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_spectrum</span><span class="o">.</span><span class="n">set_peaks</span><span class="p">(</span> <span class="p">(</span><span class="n">bin_means</span><span class="p">,</span> <span class="n">statistic</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lim</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">mz_lower_limit</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">mz_upper_limit</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">)]</span>
        <span class="n">mzs</span> <span class="o">=</span> <span class="n">mzs</span><span class="p">[</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">intensities</span><span class="p">[</span><span class="n">lim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">lim</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>

        <span class="n">idxs</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mzs</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mzs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sample_size</span><span class="p">:</span>
            <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">idxs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">new_spectrum</span><span class="o">.</span><span class="n">set_peaks</span><span class="p">(</span> <span class="p">(</span><span class="n">mzs</span><span class="p">[</span><span class="n">idxs</span><span class="p">],</span> <span class="n">intensities</span><span class="p">[</span><span class="n">idxs</span><span class="p">])</span> <span class="p">)</span> <span class="c1"># type: ignore</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_spectrum</span> <span class="o">=</span> <span class="n">spectrum</span>
    <span class="k">return</span> <span class="n">new_spectrum</span></div>



<div class="viewcode-block" id="limit_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.limit_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">limit_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">mz_lower_limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mz_upper_limit</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                     <span class="n">sample_size</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">statistic</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Limits the range of all spectra in an experiment to &lt;mz_lower_limit&gt; and &lt;mz_upper_limit&gt;. </span>
<span class="sd">    Uniformly samples &lt;sample_size&gt; number of peaks from the spectrum (without replacement).</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[pyopenms.MSExperiment, str]</span>
<span class="sd">    :param mz_lower_limit: Lower m/z value limit, defaults to 0</span>
<span class="sd">    :type mz_lower_limit: Union[int, float], optional</span>
<span class="sd">    :param mz_upper_limit: Upper m/z value limit, defaults to 10000</span>
<span class="sd">    :type mz_upper_limit: Union[int, float], optional</span>
<span class="sd">    :param sample_size: Number of sampled peaks from the spectrum, defaults to 100000</span>
<span class="sd">    :type sample_size: int, optional</span>
<span class="sd">    :param statistic: Operation to perform on binned values in a window. May take common parameters,</span>
<span class="sd">    defined by sci.stats.binned_statistic., defaults to &quot;sum&quot;</span>
<span class="sd">    :type statistic: str, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Limited and sampled experiment</span>
<span class="sd">    :rtype: oms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="n">lim_exp</span> <span class="o">=</span> <span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lim_exp</span> <span class="o">=</span> <span class="n">experiment</span>
    <span class="n">lim_exp</span><span class="o">.</span><span class="n">setSpectra</span><span class="p">(</span>
        <span class="p">[</span><span class="n">limit_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">mz_lower_limit</span><span class="p">,</span> <span class="n">mz_upper_limit</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">statistic</span><span class="p">)</span> <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">()])</span>
    <span class="k">return</span> <span class="n">lim_exp</span></div>




<div class="viewcode-block" id="trim_threshold">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.trim_threshold">[docs]</a>
<span class="k">def</span> <span class="nf">trim_threshold</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes point below an absolute intensity theshold.</span>

<span class="sd">    :param experiment: Input Experiment</span>
<span class="sd">    :type experiment: pyopenms.MSExperiment</span>
<span class="sd">    :param threshold: Threshold for values to be excluded, defaults to 0.05</span>
<span class="sd">    :type threshold: float, optional</span>
<span class="sd">    :return: Trimmed experiment</span>
<span class="sd">    :rtype: oms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tm</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">ThresholdMower</span><span class="p">()</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">tm</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
    <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">filterPeakMap</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">experiment</span></div>


<div class="viewcode-block" id="trim_threshold_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.trim_threshold_batch">[docs]</a>
<span class="k">def</span> <span class="nf">trim_threshold_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">run_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                         <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Removes points below an absolute intensity theshold in a batch of experiments.</span>

<span class="sd">    :param experiments: Input Experiments (as a list of experiments, a directory, or paths to experiemnts)</span>
<span class="sd">    :type experiments: Union[Sequence[Union[pyopenms.MSExperiment,str]], str]</span>
<span class="sd">    :param threshold: Threshold for values to be excluded, defaults to 0.05</span>
<span class="sd">    :type threshold: float, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Folder with trimmed experiments</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span> <span class="n">clean_dir</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;trimmed&quot;</span><span class="p">)</span> <span class="p">)</span>

    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span><span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span> <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">experiments</span><span class="p">]</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">load_names_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">)</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">,</span> <span class="n">data_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">)):</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">trimmed_exp</span> <span class="o">=</span> <span class="n">trim_threshold</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">MzMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_dir</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mzML&quot;</span><span class="p">),</span> <span class="n">trimmed_exp</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">trimmed_exp</span>
    <span class="k">return</span> <span class="n">cleaned_dir</span></div>




<span class="c1"># Combination</span>
<div class="viewcode-block" id="sum_spectra">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.sum_spectra">[docs]</a>
<span class="k">def</span> <span class="nf">sum_spectra</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sum up spectra in one experiment.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: pyopenms.MSExperiment</span>
<span class="sd">    :return: Spectrum with summed intensities along m/z axis</span>
<span class="sd">    :rtype: pyopenms.MSSpectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spectrum</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">intensities_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spectrum</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
    <span class="n">mzs_all</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">experiment</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">():</span>
        <span class="n">mzs</span><span class="p">,</span> <span class="n">intensities</span> <span class="o">=</span> <span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()</span>
        <span class="n">intensities_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">intensities_all</span><span class="p">,</span> <span class="n">intensities</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="n">comb_spectrum</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">()</span>
    <span class="n">comb_spectrum</span><span class="o">.</span><span class="n">set_peaks</span><span class="p">(</span> <span class="p">(</span><span class="n">mzs_all</span><span class="p">,</span> <span class="n">intensities_all</span><span class="p">)</span> <span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="k">return</span> <span class="n">comb_spectrum</span></div>



<div class="viewcode-block" id="combine_spectra_experiments">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.combine_spectra_experiments">[docs]</a>
<span class="k">def</span> <span class="nf">combine_spectra_experiments</span><span class="p">(</span><span class="n">spectra_container</span><span class="p">:</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combines all spectra/experiements, into different spectra in one experiment</span>

<span class="sd">    :param spectra_container: Input experiments</span>
<span class="sd">    :type spectra_container: Sequence[Union[oms.MSExperiment,oms.MSSpectrum]]</span>
<span class="sd">    :return: Experiment with summed intensities along m/z axis</span>
<span class="sd">    :rtype: oms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment_all</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">spectra_container</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">):</span>
            <span class="n">sc</span><span class="o">.</span><span class="n">setRT</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">experiment_all</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">():</span>            <span class="c1"># type: ignore</span>
                <span class="n">spectrum</span><span class="o">.</span><span class="n">setRT</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">experiment_all</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">experiment_all</span></div>




<span class="c1"># Smoothing</span>
<div class="viewcode-block" id="smooth_spectra">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.smooth_spectra">[docs]</a>
<span class="k">def</span> <span class="nf">smooth_spectra</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">gaussian_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply a Gaussian filter to all spectra in an experiment.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[pyopenms.MSExperiment, str]</span>
<span class="sd">    :param gaussian_width: Window width to apply smoothing to</span>
<span class="sd">    :type gaussian_width: float</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Smoothed experiment</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="n">smooth_exp</span> <span class="o">=</span> <span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">smooth_exp</span> <span class="o">=</span> <span class="n">experiment</span>
    <span class="n">smooth_exp</span><span class="o">.</span><span class="n">setSpectra</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">())</span>
    <span class="n">gf</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">GaussFilter</span><span class="p">()</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
    <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;gaussian_width&quot;</span><span class="p">,</span> <span class="n">gaussian_width</span><span class="p">)</span>
    <span class="n">gf</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
    <span class="n">gf</span><span class="o">.</span><span class="n">filterExperiment</span><span class="p">(</span><span class="n">smooth_exp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">smooth_exp</span></div>



<span class="c1"># Centroiding</span>
<div class="viewcode-block" id="centroid_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.centroid_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">centroid_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">instrument</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;TOF&quot;</span><span class="p">,</span>
                        <span class="n">signal_to_noise</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">spacing_difference_gap</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                        <span class="n">spacing_difference</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">missing</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span>
                        <span class="n">report_FWHM</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="n">report_FWHM_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span> <span class="n">max_intensity</span><span class="p">:</span><span class="nb">float</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">auto_max_stdev_factor</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">auto_max_percentile</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">auto_mode</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">win_len</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">bin_count</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_required_elements</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                        <span class="n">noise_for_empty_window</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1e+20</span><span class="p">,</span> <span class="n">write_log_messages</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                        <span class="n">peak_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sn_bin_count</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nr_iterations</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sn_win_len</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
                        <span class="n">check_width_internally</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">ms1_only</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="n">clear_meta_data</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
                        <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reduce dataset to centroids.</span>

<span class="sd">    Usecase</span>
<span class="sd">    fia_df[&quot;cent_experiment&quot;] = fia_df[&quot;experiment&quot;].apply(lambda experiment: centroid_experiment(experiment, instrument=&quot;TOF&quot;,                                      # For All</span>
<span class="sd">                                                                                                signal_to_noise=2.0, spacing_difference=1.5,</span>
<span class="sd">                                                                                                                        </span>
<span class="sd">                                                                                                spacing_difference_gap=4.0, missing=1, ms_levels=[1],                   # For Orbitrap</span>
<span class="sd">                                                                                                report_FWHM=&quot;true&quot;, report_FWHM_unit=&quot;relative&quot;, max_intensity=-1,</span>
<span class="sd">                                                                                                auto_max_stdev_factor=3.0, auto_max_percentile=95, auto_mode=0,</span>
<span class="sd">                                                                                                win_len=200.0, bin_count=30, min_required_elements=10, </span>
<span class="sd">                                                                                                noise_for_empty_window=1e+20, write_log_messages=&quot;true&quot;,</span>

<span class="sd">                                                                                                peak_width=0.0, sn_bin_count=30, nr_iterations=5, sn_win_len=20.0,      # For TOF</span>
<span class="sd">                                                                                                check_width_internally=&quot;false&quot;, ms1_only=&quot;true&quot;, clear_meta_data=&quot;false&quot;,</span>
<span class="sd">                                                                                                deepcopy=False))</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[pyopenms.MSExperiment, str]</span>
<span class="sd">    :param instrument: Instrument type (TOF or FT-ICR, Orbitrap), defaults to &quot;TOF&quot;</span>
<span class="sd">    :type instrument: str, optional</span>
<span class="sd">    :param signal_to_noise: Signal to noise ratio, defaults to 1.0</span>
<span class="sd">    :type signal_to_noise: float, optional</span>
<span class="sd">    :param spacing_difference_gap: Spacing difference gap, defaults to 4.0</span>
<span class="sd">    :type spacing_difference_gap: float, optional</span>
<span class="sd">    :param spacing_difference: Spacing difference, defaults to 1.5</span>
<span class="sd">    :type spacing_difference: float, optional</span>
<span class="sd">    :param missing: Number of allowed missing values, defaults to 1</span>
<span class="sd">    :type missing: int, optional</span>
<span class="sd">    :param ms_levels: MS levels to consider, defaults to []</span>
<span class="sd">    :type ms_levels: List[int], optional</span>
<span class="sd">    :param report_FWHM: Report full width at half maximum, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_FWHM: str, optional</span>
<span class="sd">    :param report_FWHM_unit: Report full width at half maximum unit, defaults to &quot;relative&quot;</span>
<span class="sd">    :type report_FWHM_unit: str, optional</span>
<span class="sd">    :param max_intensity: Maximum intensity, defaults to -1</span>
<span class="sd">    :type max_intensity: float, optional</span>
<span class="sd">    :param auto_max_stdev_factor: Automatic maximal standard deviation factor, defaults to 3.0</span>
<span class="sd">    :type auto_max_stdev_factor: float, optional</span>
<span class="sd">    :param auto_max_percentile: Automatic maximal percentile to consider, defaults to 95</span>
<span class="sd">    :type auto_max_percentile: int, optional</span>
<span class="sd">    :param auto_mode: Automatic mode (0/1), defaults to 0</span>
<span class="sd">    :type auto_mode: int, optional</span>
<span class="sd">    :param win_len: Window length, defaults to 200.0</span>
<span class="sd">    :type win_len: float, optional</span>
<span class="sd">    :param bin_count: Number of bins, defaults to 30</span>
<span class="sd">    :type bin_count: int, optional</span>
<span class="sd">    :param min_required_elements: Minimum required elements for a peak, defaults to 10</span>
<span class="sd">    :type min_required_elements: int, optional</span>
<span class="sd">    :param noise_for_empty_window: Noise value for an empty window, defaults to 1e+20</span>
<span class="sd">    :type noise_for_empty_window: float, optional</span>
<span class="sd">    :param write_log_messages: Write log messages (true/false), defaults to &quot;true&quot;</span>
<span class="sd">    :type write_log_messages: str, optional</span>
<span class="sd">    :param peak_width: Expected peak width, defaults to 0.0</span>
<span class="sd">    :type peak_width: float, optional</span>
<span class="sd">    :param sn_bin_count: Signal bin count, defaults to 30</span>
<span class="sd">    :type sn_bin_count: int, optional</span>
<span class="sd">    :param nr_iterations: Iterations to recenter peaks, defaults to 5</span>
<span class="sd">    :type nr_iterations: int, optional</span>
<span class="sd">    :param sn_win_len: Signal window length, defaults to 20.0</span>
<span class="sd">    :type sn_win_len: float, optional</span>
<span class="sd">    :param check_width_internally: Check width internally, defaults to &quot;false&quot;</span>
<span class="sd">    :type check_width_internally: str, optional</span>
<span class="sd">    :param ms1_only: Only MS1 spectrum, defaults to &quot;true&quot;</span>
<span class="sd">    :type ms1_only: str, optional</span>
<span class="sd">    :param clear_meta_data: Clear meta data, defaults to &quot;false&quot;</span>
<span class="sd">    :type clear_meta_data: str, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Centroided experiment</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="n">accu_exp</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;FT-ICR-MS&quot;</span><span class="p">,</span> <span class="s2">&quot;Orbitrap&quot;</span><span class="p">]:</span>
        <span class="n">pphr</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">PeakPickerHiRes</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">pphr</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;signal_to_noise&quot;</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;spacing_difference_gap&quot;</span><span class="p">,</span> <span class="n">spacing_difference_gap</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;spacing_difference&quot;</span><span class="p">,</span> <span class="n">spacing_difference</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;missing&quot;</span><span class="p">,</span> <span class="n">missing</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;ms_levels&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;report_FWHM&quot;</span><span class="p">,</span> <span class="n">report_FWHM</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;report_FWHM_unit&quot;</span><span class="p">,</span> <span class="n">report_FWHM_unit</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:max_intensity&quot;</span><span class="p">,</span> <span class="n">max_intensity</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:auto_max_stdev_factor&quot;</span><span class="p">,</span> <span class="n">auto_max_stdev_factor</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:auto_max_percentile&quot;</span><span class="p">,</span> <span class="n">auto_max_percentile</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:auto_mode&quot;</span><span class="p">,</span> <span class="n">auto_mode</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:win_len&quot;</span><span class="p">,</span> <span class="n">win_len</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:bin_count&quot;</span><span class="p">,</span> <span class="n">bin_count</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:min_required_elements&quot;</span><span class="p">,</span> <span class="n">min_required_elements</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:noise_for_empty_window&quot;</span><span class="p">,</span> <span class="n">noise_for_empty_window</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;SignalToNoise:write_log_messages&quot;</span><span class="p">,</span> <span class="n">write_log_messages</span><span class="p">)</span>
        <span class="n">pphr</span><span class="o">.</span><span class="n">pickExperiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">accu_exp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">instrument</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;TOF-MS&quot;</span><span class="p">]:</span>
        <span class="n">ppi</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">PeakPickerIterative</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">ppi</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;signal_to_noise&quot;</span><span class="p">,</span> <span class="n">signal_to_noise</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;peak_width&quot;</span><span class="p">,</span> <span class="n">peak_width</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;spacing_difference&quot;</span><span class="p">,</span> <span class="n">spacing_difference</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;sn_bin_count_&quot;</span><span class="p">,</span> <span class="n">sn_bin_count</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;nr_iterations_&quot;</span><span class="p">,</span> <span class="n">nr_iterations</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;sn_win_len_&quot;</span><span class="p">,</span> <span class="n">sn_win_len</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;check_width_internally&quot;</span><span class="p">,</span> <span class="n">check_width_internally</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;ms1_only&quot;</span><span class="p">,</span> <span class="n">ms1_only</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;clear_meta_data&quot;</span><span class="p">,</span> <span class="n">clear_meta_data</span><span class="p">)</span>
        <span class="n">ppi</span><span class="o">.</span><span class="n">pickExperiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">accu_exp</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">PeakPickerHiRes</span><span class="p">()</span><span class="o">.</span><span class="n">pickExperiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">accu_exp</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">centroid_exp</span> <span class="o">=</span> <span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span> <span class="k">if</span> <span class="n">deepcopy</span> <span class="k">else</span> <span class="n">experiment</span>
    <span class="n">centroid_exp</span><span class="o">.</span><span class="n">setSpectra</span><span class="p">(</span><span class="n">accu_exp</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">centroid_exp</span></div>


<div class="viewcode-block" id="centroid_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.centroid_batch">[docs]</a>
<span class="k">def</span> <span class="nf">centroid_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">run_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span>
                   <span class="n">instrument</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;TOF&quot;</span><span class="p">,</span>
                   <span class="n">signal_to_noise</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">spacing_difference_gap</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                   <span class="n">spacing_difference</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">missing</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">report_FWHM</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="n">report_FWHM_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;relative&quot;</span><span class="p">,</span> <span class="n">max_intensity</span><span class="p">:</span><span class="nb">float</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">auto_max_stdev_factor</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">auto_max_percentile</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">95</span><span class="p">,</span> <span class="n">auto_mode</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">win_len</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">bin_count</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">min_required_elements</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                   <span class="n">noise_for_empty_window</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1e+20</span><span class="p">,</span> <span class="n">write_log_messages</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                   <span class="n">peak_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sn_bin_count</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">nr_iterations</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">sn_win_len</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span>
                   <span class="n">check_width_internally</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">ms1_only</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="n">clear_meta_data</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
                   <span class="n">deepcopy</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Centroids a batch of experiments, extracted from files in a given directory with a given file ending (i.e. .mzML or .mzXML).</span>
<span class="sd">    Returns the new directors as path/centroids.</span>

<span class="sd">    :param experiments: Input experiments</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param run_dir: Run directory</span>
<span class="sd">    :type run_dir: str</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :param instrument: Instrument type (TOF or FT-ICR, Orbitrap), defaults to &quot;TOF&quot;</span>
<span class="sd">    :type instrument: str, optional</span>
<span class="sd">    :param signal_to_noise: Signal to noise ratio, defaults to 1.0</span>
<span class="sd">    :type signal_to_noise: float, optional</span>
<span class="sd">    :param spacing_difference_gap: Spacing difference gap, defaults to 4.0</span>
<span class="sd">    :type spacing_difference_gap: float, optional</span>
<span class="sd">    :param spacing_difference: Spacing difference, defaults to 1.5</span>
<span class="sd">    :type spacing_difference: float, optional</span>
<span class="sd">    :param missing: Number of allowed missing values, defaults to 1</span>
<span class="sd">    :type missing: int, optional</span>
<span class="sd">    :param ms_levels: MS levels to consider, defaults to []</span>
<span class="sd">    :type ms_levels: List[int], optional</span>
<span class="sd">    :param report_FWHM: Report full width at half maximum, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_FWHM: str, optional</span>
<span class="sd">    :param report_FWHM_unit: Report full width at half maximum unit, defaults to &quot;relative&quot;</span>
<span class="sd">    :type report_FWHM_unit: str, optional</span>
<span class="sd">    :param max_intensity: Maximum intensity, defaults to -1</span>
<span class="sd">    :type max_intensity: float, optional</span>
<span class="sd">    :param auto_max_stdev_factor: Automatic maximal standard deviation factor, defaults to 3.0</span>
<span class="sd">    :type auto_max_stdev_factor: float, optional</span>
<span class="sd">    :param auto_max_percentile: Automatic maximal percentile to consider, defaults to 95</span>
<span class="sd">    :type auto_max_percentile: int, optional</span>
<span class="sd">    :param auto_mode: Automatic mode (0/1), defaults to 0</span>
<span class="sd">    :type auto_mode: int, optional</span>
<span class="sd">    :param win_len: Window length, defaults to 200.0</span>
<span class="sd">    :type win_len: float, optional</span>
<span class="sd">    :param bin_count: Number of bins, defaults to 30</span>
<span class="sd">    :type bin_count: int, optional</span>
<span class="sd">    :param min_required_elements: Minimum required elements for a peak, defaults to 10</span>
<span class="sd">    :type min_required_elements: int, optional</span>
<span class="sd">    :param noise_for_empty_window: Noise value for an empty window, defaults to 1e+20</span>
<span class="sd">    :type noise_for_empty_window: float, optional</span>
<span class="sd">    :param write_log_messages: Write log messages (true/false), defaults to &quot;true&quot;</span>
<span class="sd">    :type write_log_messages: str, optional</span>
<span class="sd">    :param peak_width: Expected peak width, defaults to 0.0</span>
<span class="sd">    :type peak_width: float, optional</span>
<span class="sd">    :param sn_bin_count: Signal bin count, defaults to 30</span>
<span class="sd">    :type sn_bin_count: int, optional</span>
<span class="sd">    :param nr_iterations: Iterations to recenter peaks, defaults to 5</span>
<span class="sd">    :type nr_iterations: int, optional</span>
<span class="sd">    :param sn_win_len: Signal window length, defaults to 20.0</span>
<span class="sd">    :type sn_win_len: float, optional</span>
<span class="sd">    :param check_width_internally: Check width internally, defaults to &quot;false&quot;</span>
<span class="sd">    :type check_width_internally: str, optional</span>
<span class="sd">    :param ms1_only: Only MS1 spectrum, defaults to &quot;true&quot;</span>
<span class="sd">    :type ms1_only: str, optional</span>
<span class="sd">    :param clear_meta_data: Clear meta data, defaults to &quot;false&quot;</span>
<span class="sd">    :type clear_meta_data: str, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Directory with centroids</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span> <span class="n">clean_dir</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;centroids&quot;</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">load_names_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">)</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">,</span> <span class="n">data_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">)):</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">centroided_exp</span> <span class="o">=</span> <span class="n">centroid_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span>
                                            <span class="n">instrument</span><span class="o">=</span><span class="n">instrument</span><span class="p">,</span>
                                            <span class="n">signal_to_noise</span><span class="o">=</span><span class="n">signal_to_noise</span><span class="p">,</span> <span class="n">spacing_difference_gap</span><span class="o">=</span><span class="n">spacing_difference_gap</span><span class="p">,</span>
                                            <span class="n">spacing_difference</span><span class="o">=</span><span class="n">spacing_difference</span><span class="p">,</span> <span class="n">missing</span><span class="o">=</span><span class="n">missing</span><span class="p">,</span> <span class="n">ms_levels</span><span class="o">=</span><span class="n">ms_levels</span><span class="p">,</span>
                                            <span class="n">report_FWHM</span><span class="o">=</span><span class="n">report_FWHM</span><span class="p">,</span> <span class="n">report_FWHM_unit</span><span class="o">=</span><span class="n">report_FWHM_unit</span><span class="p">,</span> <span class="n">max_intensity</span><span class="o">=</span><span class="n">max_intensity</span><span class="p">,</span>
                                            <span class="n">auto_max_stdev_factor</span><span class="o">=</span><span class="n">auto_max_stdev_factor</span><span class="p">,</span> <span class="n">auto_max_percentile</span><span class="o">=</span><span class="n">auto_max_percentile</span><span class="p">,</span>
                                            <span class="n">auto_mode</span><span class="o">=</span><span class="n">auto_mode</span><span class="p">,</span> <span class="n">win_len</span><span class="o">=</span><span class="n">win_len</span><span class="p">,</span> <span class="n">bin_count</span><span class="o">=</span><span class="n">bin_count</span><span class="p">,</span>
                                            <span class="n">min_required_elements</span><span class="o">=</span><span class="n">min_required_elements</span><span class="p">,</span> <span class="n">noise_for_empty_window</span><span class="o">=</span><span class="n">noise_for_empty_window</span><span class="p">,</span>
                                            <span class="n">write_log_messages</span><span class="o">=</span><span class="n">write_log_messages</span><span class="p">,</span>
                                            <span class="n">peak_width</span><span class="o">=</span><span class="n">peak_width</span><span class="p">,</span> <span class="n">sn_bin_count</span><span class="o">=</span><span class="n">sn_bin_count</span><span class="p">,</span>
                                            <span class="n">nr_iterations</span><span class="o">=</span><span class="n">nr_iterations</span><span class="p">,</span> <span class="n">sn_win_len</span><span class="o">=</span><span class="n">sn_win_len</span><span class="p">,</span><span class="n">check_width_internally</span><span class="o">=</span><span class="n">check_width_internally</span><span class="p">,</span>
                                            <span class="n">ms1_only</span><span class="o">=</span><span class="n">ms1_only</span><span class="p">,</span> <span class="n">clear_meta_data</span><span class="o">=</span><span class="n">clear_meta_data</span><span class="p">,</span>
                                            <span class="n">deepcopy</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">)</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">MzMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_dir</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mzML&quot;</span><span class="p">),</span> <span class="n">centroided_exp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cleaned_dir</span></div>




<span class="c1"># Merging</span>
<div class="viewcode-block" id="merge_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.merge_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">merge_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;block_method&quot;</span><span class="p">,</span>
                     <span class="n">mz_binning_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mz_binning_width_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort_blocks</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;RT_ascending&quot;</span><span class="p">,</span>
                     <span class="n">rt_block_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rt_max_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                     <span class="n">spectrum_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">rt_range</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rt_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;scans&quot;</span><span class="p">,</span> 
                     <span class="n">rt_FWHM</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">precursor_mass_tol</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">precursor_max_charge</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge several spectra into one spectrum (useful for MS1 spectra to amplify signals)</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param method: Method to perform merging, defaults to &quot;block_method&quot;</span>
<span class="sd">    :type method: str, optional</span>
<span class="sd">    :param mz_binning_width: m/z binning width, defaults to 1.0</span>
<span class="sd">    :type mz_binning_width: float, optional</span>
<span class="sd">    :param mz_binning_width_unit: m/z binning width unit (ppm/Da), defaults to &quot;ppm&quot;</span>
<span class="sd">    :type mz_binning_width_unit: str, optional</span>
<span class="sd">    :param ms_levels: MS levels to consider, defaults to [1]</span>
<span class="sd">    :type ms_levels: List[int], optional</span>
<span class="sd">    :param sort_blocks: Sort blocks by rentention time, defaults to &quot;RT_ascending&quot;</span>
<span class="sd">    :type sort_blocks: str, optional</span>
<span class="sd">    :param rt_block_size: Block size along retention time, defaults to None</span>
<span class="sd">    :type rt_block_size: Optional[int], optional</span>
<span class="sd">    :param rt_max_length: Maximal length of Retention time, defaults to 0.0</span>
<span class="sd">    :type rt_max_length: float, optional</span>
<span class="sd">    :param spectrum_type: Spectrum type determination, defaults to &quot;automatic&quot;</span>
<span class="sd">    :type spectrum_type: str, optional</span>
<span class="sd">    :param rt_range: Retention time range to merge over, defaults to 5.0</span>
<span class="sd">    :type rt_range: Optional[float], optional</span>
<span class="sd">    :param rt_unit: Unit to merge over, defaults to &quot;scans&quot;</span>
<span class="sd">    :type rt_unit: str, optional</span>
<span class="sd">    :param rt_FWHM: Full width at half maximum, defaults to 5.0</span>
<span class="sd">    :type rt_FWHM: float, optional</span>
<span class="sd">    :param cutoff: Cutoff value during merging, defaults to 0.01</span>
<span class="sd">    :type cutoff: float, optional</span>
<span class="sd">    :param precursor_mass_tol: Percursor mass tolerance, defaults to 0.0</span>
<span class="sd">    :type precursor_mass_tol: float, optional</span>
<span class="sd">    :param precursor_max_charge: Maximal precursor charge, defaults to 1</span>
<span class="sd">    :type precursor_max_charge: int, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :raises ValueError: Method needs to be in [block_method|average_tophat|average_gaussian]</span>
<span class="sd">    :return: Merged experiment</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">rt_block_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">rt_block_size</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">getNrSpectra</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="n">merge_exp</span> <span class="o">=</span> <span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">merge_exp</span> <span class="o">=</span> <span class="n">experiment</span>

    <span class="n">merger</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">SpectraMerger</span><span class="p">()</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">merger</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
    <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;mz_binning_width&quot;</span><span class="p">,</span> <span class="n">mz_binning_width</span><span class="p">)</span>
    <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;mz_binning_width_unit&quot;</span><span class="p">,</span> <span class="n">mz_binning_width_unit</span><span class="p">)</span>
    <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;sort_blocks&quot;</span><span class="p">,</span> <span class="n">sort_blocks</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;block_method&quot;</span><span class="p">:</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;block_method:ms_levels&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;block_method:rt_block_size&quot;</span><span class="p">,</span> <span class="n">rt_block_size</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;block_method:rt_max_length&quot;</span><span class="p">,</span> <span class="n">rt_max_length</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;average_tophat&quot;</span><span class="p">:</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_tophat:ms_level&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_tophat:spectrum_type&quot;</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_tophat:rt_unit&quot;</span><span class="p">,</span> <span class="n">rt_unit</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rt_unit</span> <span class="o">==</span> <span class="s2">&quot;scans&quot;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rt_range</span><span class="p">:</span>
            <span class="n">rt_range</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">getNrSpectra</span><span class="p">())</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_tophat:rt_range&quot;</span><span class="p">,</span> <span class="n">rt_range</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;average_gaussian&quot;</span><span class="p">:</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_gaussian:ms_level&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_gaussian:spectrum_type&quot;</span><span class="p">,</span> <span class="n">spectrum_type</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_gaussian:rt_FWHM&quot;</span><span class="p">,</span> <span class="n">rt_FWHM</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_gaussian:cutoff&quot;</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_gaussian:precursor_mass_tol&quot;</span><span class="p">,</span> <span class="n">precursor_mass_tol</span><span class="p">)</span>
        <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;average_gaussian:precursor_max_charge&quot;</span><span class="p">,</span> <span class="n">precursor_max_charge</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;method needs to be one of block_method|average_tophat|average_gaussian&quot;</span><span class="p">)</span>
    
    <span class="n">merger</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;average_tophat&quot;</span><span class="p">,</span> <span class="s2">&quot;average_gaussian&quot;</span><span class="p">]:</span>
        <span class="n">merger</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">merge_exp</span><span class="p">,</span> <span class="n">method</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">merger</span><span class="o">.</span><span class="n">mergeSpectraBlockWise</span><span class="p">(</span><span class="n">merge_exp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">merge_exp</span></div>



<div class="viewcode-block" id="merge_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.merge_batch">[docs]</a>
<span class="k">def</span> <span class="nf">merge_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">run_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;block_method&quot;</span><span class="p">,</span>
                <span class="n">mz_binning_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mz_binning_width_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort_blocks</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;RT_ascending&quot;</span><span class="p">,</span>
                <span class="n">rt_block_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rt_max_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">spectrum_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">rt_range</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rt_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;scans&quot;</span><span class="p">,</span> 
                <span class="n">rt_FWHM</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">precursor_mass_tol</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">precursor_max_charge</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge several spectra into one spectrum (useful for MS1 spectra to amplify signals along near retention times)</span>

<span class="sd">    :param experiments: Input experiments</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param run_dir: Run directory</span>
<span class="sd">    :type run_dir: str</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :param method: Method to perform merging, defaults to &quot;block_method&quot;</span>
<span class="sd">    :type method: str, optional</span>
<span class="sd">    :param mz_binning_width: m/z binning width, defaults to 1.0</span>
<span class="sd">    :type mz_binning_width: float, optional</span>
<span class="sd">    :param mz_binning_width_unit: m/z binning width unit (ppm/Da), defaults to &quot;ppm&quot;</span>
<span class="sd">    :type mz_binning_width_unit: str, optional</span>
<span class="sd">    :param ms_levels: MS levels to consider, defaults to [1]</span>
<span class="sd">    :type ms_levels: List[int], optional</span>
<span class="sd">    :param sort_blocks: Sort blocks by rentention time, defaults to &quot;RT_ascending&quot;</span>
<span class="sd">    :type sort_blocks: str, optional</span>
<span class="sd">    :param rt_block_size: Block size along retention time, defaults to None</span>
<span class="sd">    :type rt_block_size: Optional[int], optional</span>
<span class="sd">    :param rt_max_length: Maximal length of Retention time, defaults to 0.0</span>
<span class="sd">    :type rt_max_length: float, optional</span>
<span class="sd">    :param spectrum_type: Spectrum type determination, defaults to &quot;automatic&quot;</span>
<span class="sd">    :type spectrum_type: str, optional</span>
<span class="sd">    :param rt_range: Retention time range to merge over, defaults to 5.0</span>
<span class="sd">    :type rt_range: Optional[float], optional</span>
<span class="sd">    :param rt_unit: Unit to merge over, defaults to &quot;scans&quot;</span>
<span class="sd">    :type rt_unit: str, optional</span>
<span class="sd">    :param rt_FWHM: Full width at half maximum, defaults to 5.0</span>
<span class="sd">    :type rt_FWHM: float, optional</span>
<span class="sd">    :param cutoff: Cutoff value during merging, defaults to 0.01</span>
<span class="sd">    :type cutoff: float, optional</span>
<span class="sd">    :param precursor_mass_tol: Percursor mass tolerance, defaults to 0.0</span>
<span class="sd">    :type precursor_mass_tol: float, optional</span>
<span class="sd">    :param precursor_max_charge: Maximal precursor charge, defaults to 1</span>
<span class="sd">    :type precursor_max_charge: int, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :raises ValueError: Method needs to be in [block_method|average_tophat|average_gaussian]</span>
<span class="sd">    :return: Directory with merged experiments</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cleaned_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span> <span class="n">clean_dir</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;merged&quot;</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">names</span> <span class="o">=</span> <span class="n">load_names_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">)</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">,</span> <span class="n">data_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">)):</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">merged_exp</span> <span class="o">=</span> <span class="n">merge_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                        <span class="n">mz_binning_width</span><span class="o">=</span><span class="n">mz_binning_width</span><span class="p">,</span> <span class="n">mz_binning_width_unit</span><span class="o">=</span><span class="n">mz_binning_width_unit</span><span class="p">,</span>
                                        <span class="n">ms_levels</span><span class="o">=</span><span class="n">ms_levels</span><span class="p">,</span> <span class="n">sort_blocks</span><span class="o">=</span><span class="n">sort_blocks</span><span class="p">,</span>
                                        <span class="n">rt_block_size</span><span class="o">=</span><span class="n">rt_block_size</span><span class="p">,</span> <span class="n">rt_max_length</span><span class="o">=</span><span class="n">rt_max_length</span><span class="p">,</span>
                                        <span class="n">spectrum_type</span><span class="o">=</span><span class="n">spectrum_type</span><span class="p">,</span> <span class="n">rt_range</span><span class="o">=</span><span class="n">rt_range</span><span class="p">,</span> <span class="n">rt_unit</span><span class="o">=</span><span class="n">rt_unit</span><span class="p">,</span>
                                        <span class="n">rt_FWHM</span><span class="o">=</span><span class="n">rt_FWHM</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">precursor_mass_tol</span><span class="o">=</span><span class="n">precursor_mass_tol</span><span class="p">,</span> <span class="n">precursor_max_charge</span><span class="o">=</span><span class="n">precursor_max_charge</span><span class="p">,</span>
                                        <span class="n">deepcopy</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">)</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">MzMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cleaned_dir</span><span class="p">,</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.mzML&quot;</span><span class="p">),</span> <span class="n">merged_exp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cleaned_dir</span></div>



<div class="viewcode-block" id="make_merge_dict">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.make_merge_dict">[docs]</a>
<span class="k">def</span> <span class="nf">make_merge_dict</span><span class="p">(</span><span class="nb">dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a dictionary for merging.</span>

<span class="sd">    :param dir: Directory to extract samples from.</span>
<span class="sd">    :type dir: str</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :return: Dictonary with sample names as keys and paths for merging as values</span>
<span class="sd">    :rtype: dict</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">names</span> <span class="o">=</span> <span class="n">load_names_batch</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">}</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">sample</span><span class="p">:</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span> <span class="ow">and</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span> <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">samples</span><span class="p">}</span></div>



<div class="viewcode-block" id="merge_experiments">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.merge_experiments">[docs]</a>
<span class="k">def</span> <span class="nf">merge_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">run_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;block_method&quot;</span><span class="p">,</span>
                    <span class="n">mz_binning_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">mz_binning_width_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">,</span> <span class="n">ms_levels</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sort_blocks</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;RT_ascending&quot;</span><span class="p">,</span>
                    <span class="n">rt_block_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rt_max_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                    <span class="n">spectrum_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;automatic&quot;</span><span class="p">,</span> <span class="n">rt_range</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rt_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;scans&quot;</span><span class="p">,</span> 
                    <span class="n">rt_FWHM</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">precursor_mass_tol</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">precursor_max_charge</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge several spectra into one spectrum (useful for MS1 spectra to amplify signals along near retention times).</span>
<span class="sd">    Combines all spectra of given experiments into one experiment to merge over.</span>

<span class="sd">    :param experiments: Input experiments</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param run_dir: Run directory</span>
<span class="sd">    :type run_dir: str</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :param method: Method to perform merging, defaults to &quot;block_method&quot;</span>
<span class="sd">    :type method: str, optional</span>
<span class="sd">    :param mz_binning_width: m/z binning width, defaults to 1.0</span>
<span class="sd">    :type mz_binning_width: float, optional</span>
<span class="sd">    :param mz_binning_width_unit: m/z binning width unit (ppm/Da), defaults to &quot;ppm&quot;</span>
<span class="sd">    :type mz_binning_width_unit: str, optional</span>
<span class="sd">    :param ms_levels: MS levels to consider, defaults to [1]</span>
<span class="sd">    :type ms_levels: List[int], optional</span>
<span class="sd">    :param sort_blocks: Sort blocks by rentention time, defaults to &quot;RT_ascending&quot;</span>
<span class="sd">    :type sort_blocks: str, optional</span>
<span class="sd">    :param rt_block_size: Block size along retention time, defaults to None</span>
<span class="sd">    :type rt_block_size: Optional[int], optional</span>
<span class="sd">    :param rt_max_length: Maximal length of Retention time, defaults to 0.0</span>
<span class="sd">    :type rt_max_length: float, optional</span>
<span class="sd">    :param spectrum_type: Spectrum type determination, defaults to &quot;automatic&quot;</span>
<span class="sd">    :type spectrum_type: str, optional</span>
<span class="sd">    :param rt_range: Retention time range to merge over, defaults to 5.0</span>
<span class="sd">    :type rt_range: Optional[float], optional</span>
<span class="sd">    :param rt_unit: Unit to merge over, defaults to &quot;scans&quot;</span>
<span class="sd">    :type rt_unit: str, optional</span>
<span class="sd">    :param rt_FWHM: Full width at half maximum, defaults to 5.0</span>
<span class="sd">    :type rt_FWHM: float, optional</span>
<span class="sd">    :param cutoff: Cutoff value during merging, defaults to 0.01</span>
<span class="sd">    :type cutoff: float, optional</span>
<span class="sd">    :param precursor_mass_tol: Percursor mass tolerance, defaults to 0.0</span>
<span class="sd">    :type precursor_mass_tol: float, optional</span>
<span class="sd">    :param precursor_max_charge: Maximal precursor charge, defaults to 1</span>
<span class="sd">    :type precursor_max_charge: int, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :raises ValueError: Method needs to be in [block_method|average_tophat|average_gaussian]</span>
<span class="sd">    :return: Directory with merged experiments</span>
<span class="sd">    :rtype: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">)</span>
    <span class="n">experiment_all</span> <span class="o">=</span> <span class="n">combine_spectra_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">)</span>
    <span class="n">merged_exp</span> <span class="o">=</span> <span class="n">merge_experiment</span><span class="p">(</span><span class="n">experiment_all</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
                                    <span class="n">mz_binning_width</span><span class="o">=</span><span class="n">mz_binning_width</span><span class="p">,</span> <span class="n">mz_binning_width_unit</span><span class="o">=</span><span class="n">mz_binning_width_unit</span><span class="p">,</span>
                                    <span class="n">ms_levels</span><span class="o">=</span><span class="n">ms_levels</span><span class="p">,</span> <span class="n">sort_blocks</span><span class="o">=</span><span class="n">sort_blocks</span><span class="p">,</span>
                                    <span class="n">rt_block_size</span><span class="o">=</span><span class="n">rt_block_size</span><span class="p">,</span> <span class="n">rt_max_length</span><span class="o">=</span><span class="n">rt_max_length</span><span class="p">,</span>
                                    <span class="n">spectrum_type</span><span class="o">=</span><span class="n">spectrum_type</span><span class="p">,</span> <span class="n">rt_range</span><span class="o">=</span><span class="n">rt_range</span><span class="p">,</span> <span class="n">rt_unit</span><span class="o">=</span><span class="n">rt_unit</span><span class="p">,</span>
                                    <span class="n">rt_FWHM</span><span class="o">=</span><span class="n">rt_FWHM</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">precursor_mass_tol</span><span class="o">=</span><span class="n">precursor_mass_tol</span><span class="p">,</span> <span class="n">precursor_max_charge</span><span class="o">=</span><span class="n">precursor_max_charge</span><span class="p">,</span>
                                    <span class="n">deepcopy</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">merged_exp</span></div>



<div class="viewcode-block" id="merge_mz_tolerance">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.merge_mz_tolerance">[docs]</a>
<span class="k">def</span> <span class="nf">merge_mz_tolerance</span><span class="p">(</span><span class="n">comb_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">charge</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">binned</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Weighted average of m/z values that are within absolute tolerance of a row in the primary dataframe.</span>

<span class="sd">    :param comb_df: Dataframe for merging</span>
<span class="sd">    :type comb_df: pandas.DataFrame</span>
<span class="sd">    :param charge: Theoretical charge, defaults to 1</span>
<span class="sd">    :type charge: int, optional</span>
<span class="sd">    :param tolerance: Tolerance of m/z difference, defaults to 1e-3</span>
<span class="sd">    :type tolerance: float, optional</span>
<span class="sd">    :param binned: Values already binned (simpler process), defaults to False</span>
<span class="sd">    :type binned: bool, optional</span>
<span class="sd">    :return: Merged Dataframe</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">df1</span> <span class="o">=</span> <span class="n">comb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comb_df</span><span class="p">[</span><span class="s2">&quot;polarity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">charge</span><span class="p">,</span> <span class="s2">&quot;clustered_experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">long</span><span class="o">=</span><span class="kc">True</span><span class="p">)[[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;inty&quot;</span><span class="p">]]</span>
    <span class="n">df2</span> <span class="o">=</span> <span class="n">comb_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comb_df</span><span class="p">[</span><span class="s2">&quot;polarity&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="n">charge</span><span class="p">,</span> <span class="s2">&quot;clustered_experiment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">long</span><span class="o">=</span><span class="kc">True</span><span class="p">)[[</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;inty&quot;</span><span class="p">]]</span>
    <span class="n">df_comb</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df1</span><span class="p">,</span> <span class="n">df2</span><span class="p">])</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">mzs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">binned</span><span class="p">:</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">df_comb</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">df_comb</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">(),</span> <span class="n">tolerance</span><span class="p">),</span> <span class="n">df_comb</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="n">digitized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">df_comb</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">digitized</span><span class="p">)):</span>
            <span class="n">mzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">digitized</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">digitized</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="s2">&quot;inty&quot;</span><span class="p">]))</span>
            <span class="n">intys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">digitized</span> <span class="o">==</span> <span class="n">i</span><span class="p">][</span><span class="s2">&quot;inty&quot;</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">df_comb</span><span class="p">))</span> <span class="k">as</span> <span class="n">progress_bar</span><span class="p">:</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">df_comb</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">mz_comp</span> <span class="o">=</span> <span class="n">df_comb</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">df_comb</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;mz&quot;</span><span class="p">]</span>
                <span class="n">inty_comp</span> <span class="o">=</span> <span class="n">df_comb</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">df_comb</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;inty&quot;</span><span class="p">]</span>
                <span class="n">comb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">mz_comp</span><span class="p">,</span> <span class="n">df_comb</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)</span>

                <span class="n">mzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="s2">&quot;mz&quot;</span><span class="p">],</span> <span class="n">mz_comp</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="s2">&quot;inty&quot;</span><span class="p">],</span> <span class="n">inty_comp</span><span class="p">)))</span>
                <span class="n">intys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">comb</span><span class="p">][</span><span class="s2">&quot;inty&quot;</span><span class="p">],</span> <span class="n">mz_comp</span><span class="p">)))</span>
                
                <span class="n">df_comb</span> <span class="o">=</span> <span class="n">df_comb</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">comb</span><span class="p">]</span>
                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">comb</span><span class="p">))</span>

    <span class="n">merged_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;mz&quot;</span><span class="p">:</span> <span class="n">mzs</span><span class="p">,</span> <span class="s2">&quot;inty&quot;</span><span class="p">:</span> <span class="n">intys</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">merged_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;mz&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>




<span class="c1"># Normalization</span>
<div class="viewcode-block" id="normalize_spectra">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.normalize_spectra">[docs]</a>
<span class="k">def</span> <span class="nf">normalize_spectra</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">normalization_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;to_one&quot;</span><span class="p">,</span>
                      <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalizes spectra by specified method.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param normalization_method: _description_, defaults to &quot;to_one&quot;</span>
<span class="sd">    :type normalization_method: Normalization method in [to_TIC | to_one] , optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Normlaized experiment along spectra</span>
<span class="sd">    :rtype: oms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="n">norm_exp</span> <span class="o">=</span> <span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm_exp</span> <span class="o">=</span> <span class="n">experiment</span>
    <span class="n">norm_exp</span><span class="o">.</span><span class="n">setSpectra</span><span class="p">(</span><span class="n">experiment</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">())</span>

    <span class="n">normalizer</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">Normalizer</span><span class="p">()</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">normalizer</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
    <span class="n">param</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="n">normalization_method</span><span class="p">)</span>
    <span class="n">normalizer</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="n">normalizer</span><span class="o">.</span><span class="n">filterPeakMap</span><span class="p">(</span><span class="n">norm_exp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">norm_exp</span></div>


<span class="c1"># Deisotoping</span>
<div class="viewcode-block" id="deisotope_spectrum">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.deisotope_spectrum">[docs]</a>
<span class="k">def</span> <span class="nf">deisotope_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">:</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">,</span> <span class="n">fragment_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">fragment_unit_ppm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">min_charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                       <span class="n">keep_only_deisotoped</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">min_isopeaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_isopeaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                       <span class="n">make_single_charged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">annotate_charge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">annotate_iso_peak_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">use_decreasing_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">start_intensity_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">add_up_intensity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to combine isotopes in a spectrum through exhaustive calculation.</span>

<span class="sd">    :param spectrum: Input spectrum</span>
<span class="sd">    :type spectrum: pyopenms.MSSpectrum</span>
<span class="sd">    :param fragment_tolerance: Tolerance for fragments, defaults to 0.1</span>
<span class="sd">    :type fragment_tolerance: float, optional</span>
<span class="sd">    :param fragment_unit_ppm: Use ppm as fragmentation unit, defaults to False</span>
<span class="sd">    :type fragment_unit_ppm: bool, optional</span>
<span class="sd">    :param min_charge: Minimal charge, defaults to 1</span>
<span class="sd">    :type min_charge: int, optional</span>
<span class="sd">    :param max_charge: Maximum charge, defaults to 3</span>
<span class="sd">    :type max_charge: int, optional</span>
<span class="sd">    :param keep_only_deisotoped: Keep only deisotoped signals, defaults to True</span>
<span class="sd">    :type keep_only_deisotoped: bool, optional</span>
<span class="sd">    :param min_isopeaks: Minimum amount of isotopes for a signal, defaults to 2</span>
<span class="sd">    :type min_isopeaks: int, optional</span>
<span class="sd">    :param max_isopeaks: Maximum amount of isotopes in a signal, defaults to 10</span>
<span class="sd">    :type max_isopeaks: int, optional</span>
<span class="sd">    :param make_single_charged: Adapt isotops to single hydrogen adducts/deducts, defaults to True</span>
<span class="sd">    :type make_single_charged: bool, optional</span>
<span class="sd">    :param annotate_charge: Annotate the charge, defaults to True</span>
<span class="sd">    :type annotate_charge: bool, optional</span>
<span class="sd">    :param annotate_iso_peak_count: Annotate isotopic peak count, defaults to True</span>
<span class="sd">    :type annotate_iso_peak_count: bool, optional</span>
<span class="sd">    :param use_decreasing_model: Use decreasing model (decreased chance of isotopes with further changes), defaults to True</span>
<span class="sd">    :type use_decreasing_model: bool, optional</span>
<span class="sd">    :param start_intensity_check: Intensity check at the start, defaults to False</span>
<span class="sd">    :type start_intensity_check: bool, optional</span>
<span class="sd">    :param add_up_intensity: Add intensity of isotopes, defaults to False</span>
<span class="sd">    :type add_up_intensity: bool, optional</span>
<span class="sd">    :return: Deisotoped spectrum</span>
<span class="sd">    :rtype: pyopenms.MSSpectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">spectrum</span><span class="o">.</span><span class="n">setFloatDataArrays</span><span class="p">([])</span>

    <span class="n">oms</span><span class="o">.</span><span class="n">Deisotoper</span><span class="o">.</span><span class="n">deisotopeAndSingleCharge</span><span class="p">(</span>
        <span class="n">spectra</span><span class="o">=</span><span class="n">spectrum</span><span class="p">,</span>
        <span class="n">fragment_tolerance</span><span class="o">=</span><span class="n">fragment_tolerance</span><span class="p">,</span>
        <span class="n">fragment_unit_ppm</span><span class="o">=</span><span class="n">fragment_unit_ppm</span><span class="p">,</span>
        <span class="n">min_charge</span><span class="o">=</span><span class="n">min_charge</span><span class="p">,</span>
        <span class="n">max_charge</span><span class="o">=</span><span class="n">max_charge</span><span class="p">,</span>
        <span class="n">keep_only_deisotoped</span><span class="o">=</span><span class="n">keep_only_deisotoped</span><span class="p">,</span>
        <span class="n">min_isopeaks</span><span class="o">=</span><span class="n">min_isopeaks</span><span class="p">,</span>
        <span class="n">max_isopeaks</span><span class="o">=</span><span class="n">max_isopeaks</span><span class="p">,</span>
        <span class="n">make_single_charged</span><span class="o">=</span><span class="n">make_single_charged</span><span class="p">,</span>
        <span class="n">annotate_charge</span><span class="o">=</span><span class="n">annotate_charge</span><span class="p">,</span>
        <span class="n">annotate_iso_peak_count</span><span class="o">=</span><span class="n">annotate_iso_peak_count</span><span class="p">,</span>
        <span class="n">use_decreasing_model</span><span class="o">=</span><span class="n">use_decreasing_model</span><span class="p">,</span>
        <span class="n">start_intensity_check</span><span class="o">=</span><span class="n">start_intensity_check</span><span class="p">,</span>
        <span class="n">add_up_intensity</span><span class="o">=</span><span class="n">add_up_intensity</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">spectrum</span></div>



<div class="viewcode-block" id="deisotope_experiment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.deisotope_experiment">[docs]</a>
<span class="k">def</span> <span class="nf">deisotope_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">fragment_tolerance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">fragment_unit_ppm</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">min_charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_charge</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                         <span class="n">keep_only_deisotoped</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">min_isopeaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">max_isopeaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                         <span class="n">make_single_charged</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">annotate_charge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">annotate_iso_peak_count</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">use_decreasing_model</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                         <span class="n">start_intensity_check</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">add_up_intensity</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                         <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to combine isotopes in an experiment through exhaustive calculation.</span>

<span class="sd">    :param spectrum: Input experiment</span>
<span class="sd">    :type spectrum: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param fragment_tolerance: Tolerance for fragments, defaults to 0.1</span>
<span class="sd">    :type fragment_tolerance: float, optional</span>
<span class="sd">    :param fragment_unit_ppm: Use ppm as fragmentation unit, defaults to False</span>
<span class="sd">    :type fragment_unit_ppm: bool, optional</span>
<span class="sd">    :param min_charge: Minimal charge, defaults to 1</span>
<span class="sd">    :type min_charge: int, optional</span>
<span class="sd">    :param max_charge: Maximum charge, defaults to 3</span>
<span class="sd">    :type max_charge: int, optional</span>
<span class="sd">    :param keep_only_deisotoped: Keep only deisotoped signals, defaults to True</span>
<span class="sd">    :type keep_only_deisotoped: bool, optional</span>
<span class="sd">    :param min_isopeaks: Minimum amount of isotopes for a signal, defaults to 2</span>
<span class="sd">    :type min_isopeaks: int, optional</span>
<span class="sd">    :param max_isopeaks: Maximum amount of isotopes in a signal, defaults to 10</span>
<span class="sd">    :type max_isopeaks: int, optional</span>
<span class="sd">    :param make_single_charged: Adapt isotops to single hydrogen adducts/deducts, defaults to True</span>
<span class="sd">    :type make_single_charged: bool, optional</span>
<span class="sd">    :param annotate_charge: Annotate the charge, defaults to True</span>
<span class="sd">    :type annotate_charge: bool, optional</span>
<span class="sd">    :param annotate_iso_peak_count: Annotate isotopic peak count, defaults to True</span>
<span class="sd">    :type annotate_iso_peak_count: bool, optional</span>
<span class="sd">    :param use_decreasing_model: Use decreasing model (decreased chance of isotopes with further changes), defaults to True</span>
<span class="sd">    :type use_decreasing_model: bool, optional</span>
<span class="sd">    :param start_intensity_check: Intensity check at the start, defaults to False</span>
<span class="sd">    :type start_intensity_check: bool, optional</span>
<span class="sd">    :param add_up_intensity: Add intensity of isotopes, defaults to False</span>
<span class="sd">    :type add_up_intensity: bool, optional</span>
<span class="sd">    :return: Deisotoped experiment</span>
<span class="sd">    :rtype: oms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>    

    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">deepcopy</span><span class="p">:</span>
        <span class="n">deisotop_exp</span> <span class="o">=</span> <span class="n">copy_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">deisotop_exp</span> <span class="o">=</span> <span class="n">experiment</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deisotop_exp</span><span class="p">):</span>
        <span class="n">deisotop_exp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">deisotope_spectrum</span><span class="p">(</span><span class="n">spectrum</span><span class="p">,</span> <span class="n">fragment_tolerance</span><span class="p">,</span> <span class="n">fragment_unit_ppm</span><span class="p">,</span> <span class="n">min_charge</span><span class="p">,</span> <span class="n">max_charge</span><span class="p">,</span>
                                             <span class="n">keep_only_deisotoped</span><span class="p">,</span>
                                             <span class="n">min_isopeaks</span><span class="p">,</span> <span class="n">max_isopeaks</span><span class="p">,</span> <span class="n">make_single_charged</span><span class="p">,</span> <span class="n">annotate_charge</span><span class="p">,</span>
                                             <span class="n">annotate_iso_peak_count</span><span class="p">,</span>
                                             <span class="n">use_decreasing_model</span><span class="p">,</span> <span class="n">start_intensity_check</span><span class="p">,</span> <span class="n">add_up_intensity</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deisotop_exp</span></div>




<span class="c1">## Feature detection</span>
<div class="viewcode-block" id="mass_trace_detection">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.mass_trace_detection">[docs]</a>
<span class="k">def</span> <span class="nf">mass_trace_detection</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                         <span class="n">mass_error_ppm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">noise_threshold_int</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">reestimate_mt_sd</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                         <span class="n">quant_method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="n">trace_termination_criterion</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;outlier&quot;</span><span class="p">,</span> <span class="n">trace_termination_outliers</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                         <span class="n">min_trace_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">max_trace_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detection of mass traces in experiment over several spectra.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param mass_error_ppm: Mass error in ppm, defaults to 10.0</span>
<span class="sd">    :type mass_error_ppm: float, optional</span>
<span class="sd">    :param noise_threshold_int: Noise threshold intensity, defaults to 1000.0</span>
<span class="sd">    :type noise_threshold_int: float, optional</span>
<span class="sd">    :param reestimate_mt_sd: Reestimate mass trace standard deviation during run, defaults to &quot;true&quot;</span>
<span class="sd">    :type reestimate_mt_sd: str, optional</span>
<span class="sd">    :param quant_method: Quantification method, defaults to &quot;median&quot;</span>
<span class="sd">    :type quant_method: str, optional</span>
<span class="sd">    :param trace_termination_criterion: Criterion to terminate a trace, defaults to &quot;outlier&quot;</span>
<span class="sd">    :type trace_termination_criterion: str, optional</span>
<span class="sd">    :param trace_termination_outliers: Number of cases that fulfil criterion/outliers to break trace, defaults to 3</span>
<span class="sd">    :type trace_termination_outliers: int, optional</span>
<span class="sd">    :param min_trace_length: Minimal trace length, defaults to 5.0</span>
<span class="sd">    :type min_trace_length: float, optional</span>
<span class="sd">    :param max_trace_length: Maximum trace length, defaults to -1.0</span>
<span class="sd">    :type max_trace_length: float, optional</span>
<span class="sd">    :return: Mass traces</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="n">experiment</span><span class="o">.</span><span class="n">sortSpectra</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">mass_traces</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">mtd</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MassTraceDetection</span><span class="p">()</span>
    <span class="n">mtd_par</span> <span class="o">=</span> <span class="n">mtd</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;mass_error_ppm&quot;</span><span class="p">,</span> <span class="n">mass_error_ppm</span><span class="p">)</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;noise_threshold_int&quot;</span><span class="p">,</span> <span class="n">noise_threshold_int</span><span class="p">)</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;reestimate_mt_sd&quot;</span><span class="p">,</span> <span class="n">reestimate_mt_sd</span><span class="p">)</span>              <span class="c1"># Dynamic re-estimation of m/z variance</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;quant_method&quot;</span><span class="p">,</span> <span class="n">quant_method</span><span class="p">)</span>                      <span class="c1"># Method of quantification for mass traces. &quot;median&quot; is recommended for direct injection</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;trace_termination_criterion&quot;</span><span class="p">,</span> <span class="n">trace_termination_criterion</span><span class="p">)</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;trace_termination_outliers&quot;</span><span class="p">,</span> <span class="n">trace_termination_outliers</span><span class="p">)</span> 
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;min_trace_length&quot;</span><span class="p">,</span> <span class="n">min_trace_length</span><span class="p">)</span>
    <span class="n">mtd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;max_trace_length&quot;</span><span class="p">,</span> <span class="n">max_trace_length</span><span class="p">)</span>
    <span class="n">mtd</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">mtd_par</span><span class="p">)</span>
    <span class="n">mtd</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">mass_traces</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mass_traces</span></div>


<div class="viewcode-block" id="mass_trace_detection_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.mass_trace_detection_batch">[docs]</a>
<span class="k">def</span> <span class="nf">mass_trace_detection_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span> 
                               <span class="n">mass_error_ppm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">noise_threshold_int</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">reestimate_mt_sd</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                               <span class="n">quant_method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="n">trace_termination_criterion</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;outlier&quot;</span><span class="p">,</span> <span class="n">trace_termination_outliers</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                               <span class="n">min_trace_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">max_trace_length</span><span class="p">:</span><span class="nb">float</span><span class="o">=-</span><span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detection of mass traces in experiment over several experiments.</span>

<span class="sd">    :param experiments: Input experiments</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :param mass_error_ppm: Mass error in ppm, defaults to 10.0</span>
<span class="sd">    :type mass_error_ppm: float, optional</span>
<span class="sd">    :param noise_threshold_int: Noise threshold intensity, defaults to 1000.0</span>
<span class="sd">    :type noise_threshold_int: float, optional</span>
<span class="sd">    :param reestimate_mt_sd: Reestimate mass trace standard deviation during run, defaults to &quot;true&quot;</span>
<span class="sd">    :type reestimate_mt_sd: str, optional</span>
<span class="sd">    :param quant_method: Quantification method, defaults to &quot;median&quot;</span>
<span class="sd">    :type quant_method: str, optional</span>
<span class="sd">    :param trace_termination_criterion: Criterion to terminate a trace, defaults to &quot;outlier&quot;</span>
<span class="sd">    :type trace_termination_criterion: str, optional</span>
<span class="sd">    :param trace_termination_outliers: Number of cases that fulfil criterion/outliers to break trace, defaults to 3</span>
<span class="sd">    :type trace_termination_outliers: int, optional</span>
<span class="sd">    :param min_trace_length: Minimal trace length, defaults to 5.0</span>
<span class="sd">    :type min_trace_length: float, optional</span>
<span class="sd">    :param max_trace_length: Maximum trace length, defaults to -1.0</span>
<span class="sd">    :type max_trace_length: float, optional</span>
<span class="sd">    :return: Mass traces</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">mass_traces_all</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">,</span> <span class="n">data_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">):</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">mass_traces_all</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">mass_trace_detection</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span> <span class="n">mass_error_ppm</span><span class="o">=</span><span class="n">mass_error_ppm</span><span class="p">,</span> <span class="n">noise_threshold_int</span><span class="o">=</span><span class="n">noise_threshold_int</span><span class="p">,</span>
                                <span class="n">reestimate_mt_sd</span><span class="o">=</span><span class="n">reestimate_mt_sd</span><span class="p">,</span> <span class="n">quant_method</span><span class="o">=</span><span class="n">quant_method</span><span class="p">,</span> <span class="n">trace_termination_criterion</span><span class="o">=</span><span class="n">trace_termination_criterion</span><span class="p">,</span>
                                <span class="n">trace_termination_outliers</span><span class="o">=</span><span class="n">trace_termination_outliers</span><span class="p">,</span> <span class="n">min_trace_length</span><span class="o">=</span><span class="n">min_trace_length</span><span class="p">,</span> <span class="n">max_trace_length</span><span class="o">=</span><span class="n">max_trace_length</span><span class="p">)</span>
        <span class="p">)</span>
            
    <span class="k">return</span> <span class="n">mass_traces_all</span></div>



<div class="viewcode-block" id="elution_peak_detection">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.elution_peak_detection">[docs]</a>
<span class="k">def</span> <span class="nf">elution_peak_detection</span><span class="p">(</span><span class="n">mass_traces</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">chrom_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">chrom_peak_snr</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                           <span class="n">width_filtering</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span> <span class="n">min_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
                           <span class="n">masstrace_snr_filtering</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Elution peak detection along mass traces. Relevant for chromatographic data.</span>

<span class="sd">    :param mass_traces: List of mass traces</span>
<span class="sd">    :type mass_traces: list</span>
<span class="sd">    :param chrom_fwhm: Chromatographic full width at half maximum, defaults to 10.0</span>
<span class="sd">    :type chrom_fwhm: float, optional</span>
<span class="sd">    :param chrom_peak_snr: Minimum signal-to-noise a mass trace should have, defaults to 2.0</span>
<span class="sd">    :type chrom_peak_snr: float, optional</span>
<span class="sd">    :param width_filtering: Type of width filtering, defaults to &quot;fixed&quot;</span>
<span class="sd">    :type width_filtering: str, optional</span>
<span class="sd">    :param min_fwhm: Minimal full width at half maximum, defaults to 1.0</span>
<span class="sd">    :type min_fwhm: float, optional</span>
<span class="sd">    :param max_fwhm: Maximal full width at half maximum, defaults to 60.0</span>
<span class="sd">    :type max_fwhm: float, optional</span>
<span class="sd">    :param masstrace_snr_filtering: Filtering by signal to noise ratio, defaults to &quot;false&quot;</span>
<span class="sd">    :type masstrace_snr_filtering: str, optional</span>
<span class="sd">    :return: List of final mass traces</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mass_traces_deconvol</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">epd</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">ElutionPeakDetection</span><span class="p">()</span>
    <span class="n">epd_par</span> <span class="o">=</span> <span class="n">epd</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
    <span class="c1"># The fixed setting filters out mass traces outside the [min_fwhm: 1.0, max_fwhm: 60.0] interval</span>
    <span class="n">epd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;chrom_fwhm&quot;</span><span class="p">,</span> <span class="n">chrom_fwhm</span><span class="p">)</span>              <span class="c1"># full-width-at-half-maximum of chromatographic peaks (s)</span>
    <span class="n">epd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;chrom_peak_snr&quot;</span><span class="p">,</span> <span class="n">chrom_peak_snr</span><span class="p">)</span>     <span class="c1"># Signal to noise minimum</span>
    <span class="n">epd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;width_filtering&quot;</span><span class="p">,</span> <span class="n">width_filtering</span><span class="p">)</span>    <span class="c1"># auto=excludes 5% on edges, fixed: uses min_fwhm and max_fwhm</span>
    <span class="n">epd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;min_fwhm&quot;</span><span class="p">,</span> <span class="n">min_fwhm</span><span class="p">)</span>           <span class="c1"># ignored when width_filtering=&quot;auto&quot;</span>
    <span class="n">epd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;max_fwhm&quot;</span><span class="p">,</span> <span class="n">max_fwhm</span><span class="p">)</span>           <span class="c1"># ignored when width_filtering=&quot;auto&quot;</span>
    <span class="n">epd_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;masstrace_snr_filtering&quot;</span><span class="p">,</span> <span class="n">masstrace_snr_filtering</span><span class="p">)</span>
    <span class="n">epd</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">epd_par</span><span class="p">)</span>
    <span class="n">epd</span><span class="o">.</span><span class="n">detectPeaks</span><span class="p">(</span><span class="n">mass_traces</span><span class="p">,</span> <span class="n">mass_traces_deconvol</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">epd</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span><span class="o">.</span><span class="n">getValue</span><span class="p">(</span><span class="s2">&quot;width_filtering&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
        <span class="n">mass_traces_final</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">epd</span><span class="o">.</span><span class="n">filterByPeakWidth</span><span class="p">(</span><span class="n">mass_traces_deconvol</span><span class="p">,</span> <span class="n">mass_traces_final</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mass_traces_final</span> <span class="o">=</span> <span class="n">mass_traces_deconvol</span>

    <span class="k">return</span> <span class="n">mass_traces_final</span></div>


<div class="viewcode-block" id="elution_peak_detection_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.elution_peak_detection_batch">[docs]</a>
<span class="k">def</span> <span class="nf">elution_peak_detection_batch</span><span class="p">(</span><span class="n">mass_traces_all</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">],</span> <span class="n">chrom_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">chrom_peak_snr</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                 <span class="n">width_filtering</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span> <span class="n">min_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">max_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span>
                                 <span class="n">masstrace_snr_filtering</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Elution peak detection along list of mass traces. Relevant for chromatographic data.</span>

<span class="sd">    :param mass_traces_all: List of list of all mass traces</span>
<span class="sd">    :type mass_traces_all: list[list]</span>
<span class="sd">    :param chrom_fwhm: Chromatographic full width at half maximum, defaults to 10.0</span>
<span class="sd">    :type chrom_fwhm: float, optional</span>
<span class="sd">    :param chrom_peak_snr: Minimum signal-to-noise a mass trace should have, defaults to 2.0</span>
<span class="sd">    :type chrom_peak_snr: float, optional</span>
<span class="sd">    :param width_filtering: Type of width filtering, defaults to &quot;fixed&quot;</span>
<span class="sd">    :type width_filtering: str, optional</span>
<span class="sd">    :param min_fwhm: Minimal full width at half maximum, defaults to 1.0</span>
<span class="sd">    :type min_fwhm: float, optional</span>
<span class="sd">    :param max_fwhm: Maximal full width at half maximum, defaults to 60.0</span>
<span class="sd">    :type max_fwhm: float, optional</span>
<span class="sd">    :param masstrace_snr_filtering: Filtering by signal to noise ratio, defaults to &quot;false&quot;</span>
<span class="sd">    :type masstrace_snr_filtering: str, optional</span>
<span class="sd">    :return: List of list of final mass traces</span>
<span class="sd">    :rtype: list[list]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">mass_traces_all_final</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">mass_traces</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">mass_traces_all</span><span class="p">):</span>
        <span class="n">mass_traces_all_final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">elution_peak_detection</span><span class="p">(</span><span class="n">mass_traces</span><span class="o">=</span><span class="n">mass_traces</span><span class="p">,</span> <span class="n">chrom_fwhm</span><span class="o">=</span><span class="n">chrom_fwhm</span><span class="p">,</span> <span class="n">chrom_peak_snr</span><span class="o">=</span><span class="n">chrom_peak_snr</span><span class="p">,</span>
                                   <span class="n">width_filtering</span><span class="o">=</span><span class="n">width_filtering</span><span class="p">,</span> <span class="n">min_fwhm</span><span class="o">=</span><span class="n">min_fwhm</span><span class="p">,</span> <span class="n">max_fwhm</span><span class="o">=</span><span class="n">max_fwhm</span><span class="p">,</span>
                                   <span class="n">masstrace_snr_filtering</span><span class="o">=</span><span class="n">masstrace_snr_filtering</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">mass_traces_all_final</span></div>



<div class="viewcode-block" id="feature_detection_untargeted">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.feature_detection_untargeted">[docs]</a>
<span class="k">def</span> <span class="nf">feature_detection_untargeted</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                 <span class="n">mass_traces_deconvol</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope_filtering_model</span><span class="o">=</span><span class="s2">&quot;metabolites (2% RMS)&quot;</span><span class="p">,</span>
                                 <span class="n">local_rt_range</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">local_mz_range</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> 
                                 <span class="n">charge_lower_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">charge_upper_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">chrom_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">report_summed_ints</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                 <span class="n">enable_RT_filtering</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">mz_scoring_13C</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
                                 <span class="n">use_smoothed_intensities</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">report_convex_hulls</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                 <span class="n">report_chromatograms</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">remove_single_traces</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                 <span class="n">mz_scoring_by_elements</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;CHNOPS&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Untargeted feature detection in an experiment.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param mass_traces_deconvol: Deconvoluted mass traces, defaults to []</span>
<span class="sd">    :type mass_traces_deconvol: list, optional</span>
<span class="sd">    :param isotope_filtering_model: Isotope filtering model, defaults to &quot;metabolites (2% RMS)&quot;</span>
<span class="sd">    :type isotope_filtering_model: str, optional</span>
<span class="sd">    :param local_rt_range: Local retention time range, defaults to 3.0</span>
<span class="sd">    :type local_rt_range: float, optional</span>
<span class="sd">    :param local_mz_range: Local m/z range, defaults to 5.0</span>
<span class="sd">    :type local_mz_range: float, optional</span>
<span class="sd">    :param charge_lower_bound: Lower charge bound, defaults to 1</span>
<span class="sd">    :type charge_lower_bound: int, optional</span>
<span class="sd">    :param charge_upper_bound: Upper charge bound, defaults to 3</span>
<span class="sd">    :type charge_upper_bound: int, optional</span>
<span class="sd">    :param chrom_fwhm: Chromatographic full width at half maximum, defaults to 10.0</span>
<span class="sd">    :type chrom_fwhm: float, optional</span>
<span class="sd">    :param report_summed_ints: Report summed intensities, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_summed_ints: str, optional</span>
<span class="sd">    :param enable_RT_filtering: Enable retention time filtering, defaults to &quot;false&quot;</span>
<span class="sd">    :type enable_RT_filtering: str, optional</span>
<span class="sd">    :param mz_scoring_13C: Score m/z by looking at expected Carbon13 peaks, defaults to &quot;false&quot;</span>
<span class="sd">    :type mz_scoring_13C: str, optional</span>
<span class="sd">    :param use_smoothed_intensities: Use smoothed intensities (if smoothed before), defaults to &quot;false&quot;</span>
<span class="sd">    :type use_smoothed_intensities: str, optional</span>
<span class="sd">    :param report_convex_hulls: Report convex hulls, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_convex_hulls: str, optional</span>
<span class="sd">    :param report_chromatograms: Report chromatograms, defaults to &quot;false&quot;</span>
<span class="sd">    :type report_chromatograms: str, optional</span>
<span class="sd">    :param remove_single_traces: Remove single traces (only appear at one retention time), defaults to &quot;true&quot;</span>
<span class="sd">    :type remove_single_traces: str, optional</span>
<span class="sd">    :param mz_scoring_by_elements: Score m/z by present elements, defaults to &quot;false&quot;</span>
<span class="sd">    :type mz_scoring_by_elements: str, optional</span>
<span class="sd">    :param elements: Elements to consider, defaults to &quot;CHNOPS&quot;</span>
<span class="sd">    :type elements: str, optional</span>
<span class="sd">    :return: Feature Map</span>
<span class="sd">    :rtype: pyopenms.FeatureMap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">feature_map</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">()</span>  <span class="c1"># output features</span>
    <span class="n">chrom_out</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># output chromatograms</span>
    <span class="n">ffm</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureFindingMetabo</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
    
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="n">ffm_par</span> <span class="o">=</span> <span class="n">ffm</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;local_rt_range&quot;</span><span class="p">,</span> <span class="n">local_rt_range</span><span class="p">)</span>          <span class="c1"># rt range for coeluting mass traces (can be set low (3.0s ~ 2 frames/spectra), because only one peak is expected)</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;local_mz_range&quot;</span><span class="p">,</span> <span class="n">local_mz_range</span><span class="p">)</span>          <span class="c1"># mz range for isotopic traces</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;charge_lower_bound&quot;</span><span class="p">,</span> <span class="n">charge_lower_bound</span><span class="p">)</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;charge_upper_bound&quot;</span><span class="p">,</span> <span class="n">charge_upper_bound</span><span class="p">)</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;chrom_fwhm&quot;</span><span class="p">,</span> <span class="n">chrom_fwhm</span><span class="p">)</span>                  <span class="c1"># Set expected chromatographic width according to elution detection parameter</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;report_summed_ints&quot;</span><span class="p">,</span> <span class="n">report_summed_ints</span><span class="p">)</span>  <span class="c1"># Sum intesity over all traces or use monoisotopic peak intensity ? (amplyfies signal with detected isotopes)</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;enable_RT_filtering&quot;</span><span class="p">,</span> <span class="n">enable_RT_filtering</span><span class="p">)</span> <span class="c1"># Require RT overlap. &#39;false&#39; for direct injection</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;isotope_filtering_model&quot;</span><span class="p">,</span> <span class="n">isotope_filtering_model</span><span class="p">)</span> <span class="c1"># metabolites (2% RMS) = Support Vector Machine, with Root mean square deviation of 2% (for precise machines)</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;mz_scoring_13C&quot;</span><span class="p">,</span> <span class="n">mz_scoring_13C</span><span class="p">)</span>  <span class="c1"># Disable for general metabolomics</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;use_smoothed_intensities&quot;</span><span class="p">,</span> <span class="n">use_smoothed_intensities</span><span class="p">)</span>  <span class="c1"># Use Locally Weighted Scatterplot Smoothed intensities (useful, if intensity is mass-dependent (Orbitraps)) ?</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;report_convex_hulls&quot;</span><span class="p">,</span> <span class="n">report_convex_hulls</span><span class="p">)</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;report_chromatograms&quot;</span><span class="p">,</span> <span class="n">report_chromatograms</span><span class="p">)</span>  <span class="c1"># &#39;false&#39;, was not performed in Flow-injection</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;remove_single_traces&quot;</span><span class="p">,</span> <span class="n">remove_single_traces</span><span class="p">)</span>  <span class="c1"># &#39;false&#39;, there will be valuable single traces, because we have long traces, that may not match</span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;mz_scoring_by_elements&quot;</span><span class="p">,</span> <span class="n">mz_scoring_by_elements</span><span class="p">)</span> <span class="c1"># &#39;true&#39; to use expected element peaks to detect isotopes </span>
    <span class="n">ffm_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;elements&quot;</span><span class="p">,</span> <span class="n">elements</span><span class="p">)</span> <span class="c1"># Elements, that are present in sample: &quot;CHNOPS&quot;  </span>
    <span class="n">ffm</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">ffm_par</span><span class="p">)</span>

    <span class="n">ffm</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">mass_traces_deconvol</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">,</span> <span class="n">chrom_out</span><span class="p">)</span>
    <span class="n">feature_map</span><span class="o">.</span><span class="n">setUniqueIds</span><span class="p">()</span>  <span class="c1"># Assigns a new, valid unique id per feature</span>
    <span class="n">feature_map</span><span class="o">.</span><span class="n">setPrimaryMSRunPath</span><span class="p">([</span><span class="n">name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">feature_map</span></div>


<div class="viewcode-block" id="feature_detection_untargeted_batch">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.feature_detection_untargeted_batch">[docs]</a>
<span class="k">def</span> <span class="nf">feature_detection_untargeted_batch</span><span class="p">(</span><span class="n">experiments</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span><span class="nb">str</span><span class="p">]],</span> <span class="nb">str</span><span class="p">],</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span>
                                       <span class="n">mass_traces_deconvol_all</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">isotope_filtering_model</span><span class="o">=</span><span class="s2">&quot;metabolites (2% RMS)&quot;</span><span class="p">,</span>
                                       <span class="n">local_rt_range</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">local_mz_range</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> 
                                       <span class="n">charge_lower_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">charge_upper_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                       <span class="n">chrom_fwhm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">report_summed_ints</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                       <span class="n">enable_RT_filtering</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">mz_scoring_13C</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
                                       <span class="n">use_smoothed_intensities</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">report_convex_hulls</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                       <span class="n">report_chromatograms</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">remove_single_traces</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                       <span class="n">mz_scoring_by_elements</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span> <span class="n">elements</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;CHNOPS&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Untargeted feature detection in experiments.</span>

<span class="sd">    :param experiments: Input experiments</span>
<span class="sd">    :type experiments: Union[Sequence[Union[oms.MSExperiment,str]], str]</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :param mass_traces_deconvol: Deconvoluted mass traces, defaults to []</span>
<span class="sd">    :type mass_traces_deconvol: list, optional</span>
<span class="sd">    :param isotope_filtering_model: Isotope filtering model, defaults to &quot;metabolites (2% RMS)&quot;</span>
<span class="sd">    :type isotope_filtering_model: str, optional</span>
<span class="sd">    :param local_rt_range: Local retention time range, defaults to 3.0</span>
<span class="sd">    :type local_rt_range: float, optional</span>
<span class="sd">    :param local_mz_range: Local m/z range, defaults to 5.0</span>
<span class="sd">    :type local_mz_range: float, optional</span>
<span class="sd">    :param charge_lower_bound: Lower charge bound, defaults to 1</span>
<span class="sd">    :type charge_lower_bound: int, optional</span>
<span class="sd">    :param charge_upper_bound: Upper charge bound, defaults to 3</span>
<span class="sd">    :type charge_upper_bound: int, optional</span>
<span class="sd">    :param chrom_fwhm: Chromatographic full width at half maximum, defaults to 10.0</span>
<span class="sd">    :type chrom_fwhm: float, optional</span>
<span class="sd">    :param report_summed_ints: Report summed intensities, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_summed_ints: str, optional</span>
<span class="sd">    :param enable_RT_filtering: Enable retention time filtering, defaults to &quot;false&quot;</span>
<span class="sd">    :type enable_RT_filtering: str, optional</span>
<span class="sd">    :param mz_scoring_13C: Score m/z by looking at expected Carbon13 peaks, defaults to &quot;false&quot;</span>
<span class="sd">    :type mz_scoring_13C: str, optional</span>
<span class="sd">    :param use_smoothed_intensities: Use smoothed intensities (if smoothed before), defaults to &quot;false&quot;</span>
<span class="sd">    :type use_smoothed_intensities: str, optional</span>
<span class="sd">    :param report_convex_hulls: Report convex hulls, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_convex_hulls: str, optional</span>
<span class="sd">    :param report_chromatograms: Report chromatograms, defaults to &quot;false&quot;</span>
<span class="sd">    :type report_chromatograms: str, optional</span>
<span class="sd">    :param remove_single_traces: Remove single traces (only appear at one retention time), defaults to &quot;true&quot;</span>
<span class="sd">    :type remove_single_traces: str, optional</span>
<span class="sd">    :param mz_scoring_by_elements: Score m/z by present elements, defaults to &quot;false&quot;</span>
<span class="sd">    :type mz_scoring_by_elements: str, optional</span>
<span class="sd">    :param elements: Elements to consider, defaults to &quot;CHNOPS&quot;</span>
<span class="sd">    :type elements: str, optional</span>
<span class="sd">    :return: List of Feature Maps</span>
<span class="sd">    :rtype: list[pyopenms.FeatureMap]</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="n">load_experiments</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">,</span> <span class="n">data_load</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">experiment</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="p">(</span><span class="n">experiments</span><span class="p">)):</span>
        <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
        <span class="n">feature_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">feature_detection_untargeted</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                         <span class="n">mass_traces_deconvol</span><span class="o">=</span><span class="n">mass_traces_deconvol_all</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> 
                                         <span class="n">isotope_filtering_model</span><span class="o">=</span><span class="n">isotope_filtering_model</span><span class="p">,</span>
                                         <span class="n">local_rt_range</span><span class="o">=</span><span class="n">local_rt_range</span><span class="p">,</span> <span class="n">local_mz_range</span><span class="o">=</span><span class="n">local_mz_range</span><span class="p">,</span> 
                                         <span class="n">charge_lower_bound</span><span class="o">=</span><span class="n">charge_lower_bound</span><span class="p">,</span> <span class="n">charge_upper_bound</span><span class="o">=</span><span class="n">charge_upper_bound</span><span class="p">,</span>
                                         <span class="n">chrom_fwhm</span><span class="o">=</span><span class="n">chrom_fwhm</span><span class="p">,</span> <span class="n">report_summed_ints</span><span class="o">=</span><span class="n">report_summed_ints</span><span class="p">,</span>
                                         <span class="n">enable_RT_filtering</span><span class="o">=</span><span class="n">enable_RT_filtering</span><span class="p">,</span> <span class="n">mz_scoring_13C</span><span class="o">=</span><span class="n">mz_scoring_13C</span><span class="p">,</span>
                                         <span class="n">use_smoothed_intensities</span><span class="o">=</span><span class="n">use_smoothed_intensities</span><span class="p">,</span> <span class="n">report_convex_hulls</span><span class="o">=</span><span class="n">report_convex_hulls</span><span class="p">,</span>
                                         <span class="n">report_chromatograms</span><span class="o">=</span><span class="n">report_chromatograms</span><span class="p">,</span> <span class="n">remove_single_traces</span><span class="o">=</span><span class="n">remove_single_traces</span><span class="p">,</span>
                                         <span class="n">mz_scoring_by_elements</span><span class="o">=</span><span class="n">mz_scoring_by_elements</span><span class="p">,</span> <span class="n">elements</span><span class="o">=</span><span class="n">elements</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_maps</span></div>



<div class="viewcode-block" id="assign_feature_maps_polarity">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.assign_feature_maps_polarity">[docs]</a>
<span class="k">def</span> <span class="nf">assign_feature_maps_polarity</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">scan_polarity</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigns the polarity to a list of feature maps, depending on &quot;pos&quot;/&quot;neg&quot; in file name.</span>

<span class="sd">    :param feature_maps: List of feature maps</span>
<span class="sd">    :type feature_maps: list</span>
<span class="sd">    :param scan_polarity: Scan polarity, defaults to None</span>
<span class="sd">    :type scan_polarity: Optional[str], optional</span>
<span class="sd">    :return: List of feature maps with annotated polarity</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Assign polarity to feature maps:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">scan_polarity</span><span class="p">:</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">,</span> <span class="n">scan_polarity</span><span class="p">)</span>
        <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;neg&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;pos&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">fm</span><span class="o">.</span><span class="n">setMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">scan_polarity</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">setMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">,</span> <span class="n">scan_polarity</span><span class="p">)</span>
            <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;neg&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">setMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">,</span> <span class="s2">&quot;negative&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="sa">b</span><span class="s2">&quot;pos&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">setMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">,</span> <span class="s2">&quot;positive&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">feature_maps</span></div>



<div class="viewcode-block" id="detect_adducts">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.detect_adducts">[docs]</a>
<span class="k">def</span> <span class="nf">detect_adducts</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">potential_adducts</span><span class="p">:</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]</span><span class="o">=</span><span class="s2">&quot;[]&quot;</span><span class="p">,</span> <span class="n">q_try</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;feature&quot;</span><span class="p">,</span> <span class="n">mass_max_diff</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">,</span> <span class="n">max_minority_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">verbose_level</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt adduct detection through exhaustive calculations.</span>

<span class="sd">    :param feature_maps: List of feature maps</span>
<span class="sd">    :type feature_maps: list</span>
<span class="sd">    :param potential_adducts: Potential adducts to consider, defaults to &quot;[]&quot;</span>
<span class="sd">    :type potential_adducts: Union[str, bytes], optional</span>
<span class="sd">    :param q_try: Charge discovery dimension, defaults to &quot;feature&quot;</span>
<span class="sd">    :type q_try: str, optional</span>
<span class="sd">    :param mass_max_diff: Maximum mass difference, defaults to 10.0</span>
<span class="sd">    :type mass_max_diff: float, optional</span>
<span class="sd">    :param unit: Unit of mass difference, defaults to &quot;ppm&quot;</span>
<span class="sd">    :type unit: str, optional</span>
<span class="sd">    :param max_minority_bound: Maximum minority bound, defaults to 3</span>
<span class="sd">    :type max_minority_bound: int, optional</span>
<span class="sd">    :param verbose_level: Verbosity level, defaults to 0</span>
<span class="sd">    :type verbose_level: int, optional</span>
<span class="sd">    :return: Feature maps with removed adducts (deconvoluted)</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">feature_maps_adducts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Detecting adducts:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">feature_map</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">):</span>
        <span class="n">mfd</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MetaboliteFeatureDeconvolution</span><span class="p">()</span>
        <span class="n">mdf_par</span> <span class="o">=</span> <span class="n">mfd</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">potential_adducts</span><span class="p">:</span>
            <span class="n">mdf_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;potential_adducts&quot;</span><span class="p">,</span> <span class="n">potential_adducts</span><span class="p">)</span>
        <span class="n">mdf_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;verbose_level&quot;</span><span class="p">,</span> <span class="n">verbose_level</span><span class="p">)</span>
        <span class="n">mdf_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;mass_max_diff&quot;</span><span class="p">,</span> <span class="n">mass_max_diff</span><span class="p">)</span>
        <span class="n">mdf_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;unit&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">mdf_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;q_try&quot;</span><span class="p">,</span> <span class="n">q_try</span><span class="p">)</span>
        <span class="n">mdf_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="s2">&quot;max_minority_bound&quot;</span><span class="p">,</span> <span class="n">max_minority_bound</span><span class="p">)</span>
        <span class="n">mfd</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">mdf_par</span><span class="p">)</span>
        <span class="n">feature_map_adduct</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">()</span>
        <span class="n">mfd</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">feature_map_adduct</span><span class="p">,</span> <span class="n">oms</span><span class="o">.</span><span class="n">ConsensusMap</span><span class="p">(),</span> <span class="n">oms</span><span class="o">.</span><span class="n">ConsensusMap</span><span class="p">())</span>
        <span class="n">feature_maps_adducts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_map_adduct</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_maps_adducts</span></div>



<div class="viewcode-block" id="align_retention_times">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.align_retention_times">[docs]</a>
<span class="k">def</span> <span class="nf">align_retention_times</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">max_num_peaks_considered</span><span class="p">:</span><span class="nb">int</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">max_mz_difference</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">mz_unit</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;ppm&quot;</span><span class="p">,</span>
                          <span class="n">superimposer_max_scaling</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">2.0</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use as reference for alignment, the file with the largest number of features</span>
<span class="sd">    Works well if you have a pooled QC for example. Returns the aligned map at the first position.</span>

<span class="sd">    :param feature_maps: List of feature maps</span>
<span class="sd">    :type feature_maps: list</span>
<span class="sd">    :param max_num_peaks_considered: Maximum number of considered peaks, defaults to -1</span>
<span class="sd">    :type max_num_peaks_considered: int, optional</span>
<span class="sd">    :param max_mz_difference: Maximum m/z difference, defaults to 10.0</span>
<span class="sd">    :type max_mz_difference: float, optional</span>
<span class="sd">    :param mz_unit: Unit for m/z values, defaults to &quot;ppm&quot;</span>
<span class="sd">    :type mz_unit: str, optional</span>
<span class="sd">    :param superimposer_max_scaling: Maximum scaling during superimposition, defaults to 2.0</span>
<span class="sd">    :type superimposer_max_scaling: float, optional</span>
<span class="sd">    :return: List of feature maps with aligned retention times</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Searching feature map with larges number of features:&quot;</span><span class="p">)</span>
    <span class="n">ref_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">fm</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">feature_maps</span><span class="p">])</span>
    <span class="n">feature_maps</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">feature_maps</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ref_index</span><span class="p">))</span>


    <span class="n">aligner</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MapAlignmentAlgorithmPoseClustering</span><span class="p">()</span>

    <span class="n">trafos</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># parameter optimization</span>
    <span class="n">aligner_par</span> <span class="o">=</span> <span class="n">aligner</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
    <span class="n">aligner_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;max_num_peaks_considered&quot;</span><span class="p">,</span> <span class="n">max_num_peaks_considered</span> <span class="p">)</span>  <span class="c1"># -1 = infinite</span>
    <span class="n">aligner_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;pairfinder:distance_MZ:max_difference&quot;</span><span class="p">,</span> <span class="n">max_mz_difference</span> <span class="p">)</span>
    <span class="n">aligner_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;pairfinder:distance_MZ:unit&quot;</span><span class="p">,</span> <span class="s2">&quot;ppm&quot;</span> <span class="p">)</span>
    <span class="n">aligner_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;superimposer:max_scaling&quot;</span><span class="p">,</span> <span class="n">superimposer_max_scaling</span> <span class="p">)</span>
    
    <span class="n">aligner</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">aligner_par</span><span class="p">)</span>
    <span class="n">aligner</span><span class="o">.</span><span class="n">setReference</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aligning retention times:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">feature_map</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="n">trafo</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">TransformationDescription</span><span class="p">()</span>  <span class="c1"># save the transformed data points</span>
        <span class="n">aligner</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">trafo</span><span class="p">)</span>
        <span class="n">trafos</span><span class="p">[</span><span class="n">feature_map</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()]</span> <span class="o">=</span> <span class="n">trafo</span>
        <span class="n">transformer</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MapAlignmentTransformer</span><span class="p">()</span>
        <span class="n">transformer</span><span class="o">.</span><span class="n">transformRetentionTimes</span><span class="p">(</span><span class="n">feature_map</span><span class="p">,</span> <span class="n">trafo</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_maps</span></div>



<div class="viewcode-block" id="separate_feature_maps_pos_neg">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.separate_feature_maps_pos_neg">[docs]</a>
<span class="k">def</span> <span class="nf">separate_feature_maps_pos_neg</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">:</span><span class="nb">list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Separate the feature maps into positively and negatively charged feature maps.</span>

<span class="sd">    :param feature_maps: Input list of feature maps</span>
<span class="sd">    :type feature_maps: list</span>
<span class="sd">    :return: List of list of feature maps, separates into positive and negatively charged</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">positive_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">negative_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Separating feature maps:&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;positive&quot;</span><span class="p">:</span>
            <span class="n">positive_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;scan_polarity&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;negative&quot;</span><span class="p">:</span>
            <span class="n">negative_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">positive_features</span><span class="p">,</span> <span class="n">negative_features</span><span class="p">]</span></div>



<div class="viewcode-block" id="consensus_features_linking">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.consensus_features_linking">[docs]</a>
<span class="k">def</span> <span class="nf">consensus_features_linking</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">feature_grouper_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;QT&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">ConsensusMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Linking features by consensus voting.</span>

<span class="sd">    :param feature_maps: List of feature maps</span>
<span class="sd">    :type feature_maps: list</span>
<span class="sd">    :param feature_grouper_type: Quality threshold clustering (QT) or k-dimensional tree clustering, defaults to &quot;QT&quot;</span>
<span class="sd">    :type feature_grouper_type: str, optional</span>
<span class="sd">    :raises ValueError: Use QT or KD for feature groupers.</span>
<span class="sd">    :return: Consensums map of features</span>
<span class="sd">    :rtype: pyopenms.ConsensusMap</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">feature_grouper_type</span> <span class="o">==</span> <span class="s2">&quot;KD&quot;</span><span class="p">:</span>
        <span class="n">feature_grouper</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureGroupingAlgorithmKD</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">feature_grouper_type</span> <span class="o">==</span> <span class="s2">&quot;QT&quot;</span><span class="p">:</span>
        <span class="n">feature_grouper</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureGroupingAlgorithmQT</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">feature_grouper_type</span><span class="si">}</span><span class="s2"> is not in list of implemented feature groupers. Choose from [&#39;KD&#39;,&#39;QT&#39;].&quot;</span><span class="p">)</span>

    <span class="n">consensus_map</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">ConsensusMap</span><span class="p">()</span>
    <span class="n">file_descriptions</span> <span class="o">=</span> <span class="n">consensus_map</span><span class="o">.</span><span class="n">getColumnHeaders</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature_map</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">):</span>
        <span class="n">file_description</span> <span class="o">=</span> <span class="n">file_descriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">oms</span><span class="o">.</span><span class="n">ColumnHeader</span><span class="p">())</span>
        <span class="n">file_description</span><span class="o">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">feature_map</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="n">file_description</span><span class="o">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">file_description</span><span class="o">.</span><span class="n">unique_id</span> <span class="o">=</span> <span class="n">feature_map</span><span class="o">.</span><span class="n">getUniqueId</span><span class="p">()</span>

        <span class="n">file_descriptions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_description</span>

    <span class="n">feature_grouper</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">feature_maps</span><span class="p">,</span> <span class="n">consensus_map</span><span class="p">)</span>
    <span class="n">consensus_map</span><span class="o">.</span><span class="n">setColumnHeaders</span><span class="p">(</span><span class="n">file_descriptions</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">consensus_map</span></div>

    

<span class="c1"># Untargeted</span>
<div class="viewcode-block" id="untargeted_feature_detection">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.untargeted_feature_detection">[docs]</a>
<span class="k">def</span> <span class="nf">untargeted_feature_detection</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                                 <span class="n">feature_filepath</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">mass_error_ppm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
                                 <span class="n">noise_threshold_int</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3000.0</span><span class="p">,</span>
                                 <span class="n">charge_lower_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">charge_upper_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                 <span class="n">width_filtering</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
                                 <span class="n">isotope_filtering_model</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                                 <span class="n">remove_single_traces</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                 <span class="n">mz_scoring_by_elements</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
                                 <span class="n">report_convex_hulls</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                 <span class="n">deepcopy</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Untargeted detection of features. Combines mMass trace detection, elution peak detection and </span>
<span class="sd">    feature finding.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param feature_filepath: Path to featureXML file, defaults to None</span>
<span class="sd">    :type feature_filepath: Optional[str], optional</span>
<span class="sd">    :param mass_error_ppm: Mass error in ppm, defaults to 10.0</span>
<span class="sd">    :type mass_error_ppm: float, optional</span>
<span class="sd">    :param noise_threshold_int: Noise threshold intensity, defaults to 1000.0</span>
<span class="sd">    :type noise_threshold_int: float, optional</span>
<span class="sd">    :param charge_lower_bound: Lower charge bound, defaults to 1</span>
<span class="sd">    :type charge_lower_bound: int, optional</span>
<span class="sd">    :param charge_upper_bound: Upper charge bound, defaults to 3</span>
<span class="sd">    :type charge_upper_bound: int, optional</span>
<span class="sd">    :param width_filtering: Type of width filtering, defaults to &quot;fixed&quot;</span>
<span class="sd">    :type width_filtering: str, optional</span>
<span class="sd">    :param isotope_filtering_model: Isotope filtering model, defaults to &quot;metabolites (2% RMS)&quot;</span>
<span class="sd">    :type isotope_filtering_model: str, optional</span>
<span class="sd">    :param remove_single_traces: Remove single traces, defaults to &quot;true&quot;</span>
<span class="sd">    :type remove_single_traces: str, optional</span>
<span class="sd">    :param mz_scoring_by_elements: Score m/z by present elements, defaults to &quot;false&quot;</span>
<span class="sd">    :type mz_scoring_by_elements: str, optional</span>
<span class="sd">    :param report_convex_hulls: Report convex hulls, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_convex_hulls: str, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: Feature map</span>
<span class="sd">    :rtype: pyopenms.FeatureMap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="n">experiment</span><span class="o">.</span><span class="n">sortSpectra</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Mass trace detection</span>
    <span class="n">mass_traces</span> <span class="o">=</span> <span class="n">mass_trace_detection</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">mass_error_ppm</span><span class="p">,</span> <span class="n">noise_threshold_int</span><span class="p">)</span>
     
    <span class="c1"># Elution Peak Detection</span>
    <span class="n">mass_traces_deconvol</span> <span class="o">=</span> <span class="n">elution_peak_detection</span><span class="p">(</span><span class="n">mass_traces</span><span class="p">,</span> <span class="n">width_filtering</span><span class="o">=</span><span class="n">width_filtering</span><span class="p">)</span>
    
    <span class="c1"># Feature finding</span>
    <span class="n">feature_map</span> <span class="o">=</span> <span class="n">feature_detection_untargeted</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span>
                                               <span class="n">mass_traces_deconvol</span><span class="o">=</span><span class="n">mass_traces_deconvol</span><span class="p">,</span>
                                               <span class="n">isotope_filtering_model</span><span class="o">=</span><span class="n">isotope_filtering_model</span><span class="p">,</span>
                                               <span class="n">charge_lower_bound</span><span class="o">=</span><span class="n">charge_lower_bound</span><span class="p">,</span>
                                               <span class="n">charge_upper_bound</span><span class="o">=</span><span class="n">charge_upper_bound</span><span class="p">,</span>
                                               <span class="n">remove_single_traces</span><span class="o">=</span><span class="n">remove_single_traces</span><span class="p">,</span> 
                                               <span class="n">mz_scoring_by_elements</span><span class="o">=</span><span class="n">mz_scoring_by_elements</span><span class="p">,</span> 
                                               <span class="n">report_convex_hulls</span><span class="o">=</span><span class="n">report_convex_hulls</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">feature_filepath</span><span class="p">:</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">FeatureXMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">feature_filepath</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_map</span></div>


<div class="viewcode-block" id="untargeted_features_detection">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.untargeted_features_detection">[docs]</a>
<span class="k">def</span> <span class="nf">untargeted_features_detection</span><span class="p">(</span><span class="n">in_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;.mzML&quot;</span><span class="p">,</span>
                                    <span class="n">mass_error_ppm</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                                    <span class="n">noise_threshold_int</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span>
                                    <span class="n">charge_lower_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">charge_upper_bound</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">width_filtering</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
                                    <span class="n">isotope_filtering_model</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="p">,</span>
                                    <span class="n">remove_single_traces</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                    <span class="n">mz_scoring_by_elements</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
                                    <span class="n">report_convex_hulls</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
                                    <span class="n">deepcopy</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Untargeted detection of features. Combines mMass trace detection, elution peak detection and </span>
<span class="sd">    feature finding.</span>

<span class="sd">    :param in_dir: Input directory</span>
<span class="sd">    :type in_dir: str</span>
<span class="sd">    :param run_dir: Run directory</span>
<span class="sd">    :type run_dir: str</span>
<span class="sd">    :param file_ending: File ending, defaults to &quot;.mzML&quot;</span>
<span class="sd">    :type file_ending: str, optional</span>
<span class="sd">    :param mass_error_ppm: Mass error in ppm, defaults to 10.0</span>
<span class="sd">    :type mass_error_ppm: float, optional</span>
<span class="sd">    :param noise_threshold_int: Noise threshold intensity, defaults to 1000.0</span>
<span class="sd">    :type noise_threshold_int: float, optional</span>
<span class="sd">    :param charge_lower_bound: Lower charge bound, defaults to 1</span>
<span class="sd">    :type charge_lower_bound: int, optional</span>
<span class="sd">    :param charge_upper_bound: Upper charge bound, defaults to 3</span>
<span class="sd">    :type charge_upper_bound: int, optional</span>
<span class="sd">    :param width_filtering: Type of width filtering, defaults to &quot;fixed&quot;</span>
<span class="sd">    :type width_filtering: str, optional</span>
<span class="sd">    :param isotope_filtering_model: Isotope filtering model, defaults to &quot;metabolites (2% RMS)&quot;</span>
<span class="sd">    :type isotope_filtering_model: str, optional</span>
<span class="sd">    :param remove_single_traces: Remove single traces, defaults to &quot;true&quot;</span>
<span class="sd">    :type remove_single_traces: str, optional</span>
<span class="sd">    :param mz_scoring_by_elements: Score m/z by present elements, defaults to &quot;false&quot;</span>
<span class="sd">    :type mz_scoring_by_elements: str, optional</span>
<span class="sd">    :param report_convex_hulls: Report convex hulls, defaults to &quot;true&quot;</span>
<span class="sd">    :type report_convex_hulls: str, optional</span>
<span class="sd">    :param deepcopy: Perform a deepcopy to relieably unlink the experiment from the input, defaults to False</span>
<span class="sd">    :type deepcopy: bool, optional</span>
<span class="sd">    :return: List of feature maps</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">feature_folder</span> <span class="o">=</span> <span class="n">clean_dir</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">in_dir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ending</span><span class="p">):</span>
            <span class="n">experiment_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">feature_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span><span class="si">}</span><span class="s2">.featureXML&quot;</span><span class="p">)</span>
            <span class="n">feature_map</span> <span class="o">=</span> <span class="n">untargeted_feature_detection</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment_file</span><span class="p">,</span>
                                                        <span class="n">feature_filepath</span><span class="o">=</span><span class="n">feature_file</span><span class="p">,</span>
                                                        <span class="n">mass_error_ppm</span><span class="o">=</span><span class="n">mass_error_ppm</span><span class="p">,</span> <span class="n">noise_threshold_int</span><span class="o">=</span><span class="n">noise_threshold_int</span><span class="p">,</span>
                                                        <span class="n">charge_lower_bound</span><span class="o">=</span><span class="n">charge_lower_bound</span><span class="p">,</span> <span class="n">charge_upper_bound</span><span class="o">=</span><span class="n">charge_upper_bound</span><span class="p">,</span> 
                                                        <span class="n">width_filtering</span><span class="o">=</span><span class="n">width_filtering</span><span class="p">,</span> <span class="n">isotope_filtering_model</span><span class="o">=</span><span class="n">isotope_filtering_model</span><span class="p">,</span>
                                                        <span class="n">remove_single_traces</span><span class="o">=</span><span class="n">remove_single_traces</span><span class="p">,</span> <span class="n">mz_scoring_by_elements</span><span class="o">=</span><span class="n">mz_scoring_by_elements</span><span class="p">,</span>
                                                        <span class="n">report_convex_hulls</span><span class="o">=</span><span class="n">report_convex_hulls</span><span class="p">,</span>
                                                        <span class="n">deepcopy</span><span class="o">=</span><span class="n">deepcopy</span><span class="p">)</span>
            <span class="n">feature_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_map</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">feature_maps</span></div>


        

<span class="c1">## Targeted</span>
<div class="viewcode-block" id="feature_detection_targeted">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.feature_detection_targeted">[docs]</a>
<span class="k">def</span> <span class="nf">feature_detection_targeted</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">metab_table</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">feature_filepath</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">mz_window</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rt_window</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_isotopes</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">isotope_pmin</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                               <span class="n">peak_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Feature detection with a given metabolic table.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param metab_table: Metabilites table</span>
<span class="sd">    :type metab_table: list</span>
<span class="sd">    :param feature_filepath: Filpath to featureXML, defaults to None</span>
<span class="sd">    :type feature_filepath: Optional[str], optional</span>
<span class="sd">    :param mz_window: m/z window width, defaults to 5.0</span>
<span class="sd">    :type mz_window: float, optional</span>
<span class="sd">    :param rt_window: Retention time window width, defaults to None</span>
<span class="sd">    :type rt_window: Optional[float], optional</span>
<span class="sd">    :param n_isotopes: Number of considered isotopes, defaults to 2</span>
<span class="sd">    :type n_isotopes: int, optional</span>
<span class="sd">    :param isotope_pmin: Minimal probability of an isotope to be considered, defaults to 0.01</span>
<span class="sd">    :type isotope_pmin: float, optional</span>
<span class="sd">    :param peak_width: Standard peak width, defaults to 60.0</span>
<span class="sd">    :type peak_width: float, optional</span>
<span class="sd">    :return: Feature map</span>
<span class="sd">    :rtype: oms.FeatureMap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">experiment</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>

    <span class="c1"># FeatureMap to store results</span>
    <span class="n">feature_map</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">()</span>
    
    <span class="c1"># create FeatureFinderAlgorithmMetaboIdent and assign ms data</span>
    <span class="n">ff</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureFinderAlgorithmMetaboIdent</span><span class="p">()</span>
    <span class="n">ff</span><span class="o">.</span><span class="n">setMSData</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    <span class="n">ff_par</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">getDefaults</span><span class="p">()</span>
    <span class="n">ff_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;extract:mz_window&quot;</span><span class="p">,</span>  <span class="n">mz_window</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rt_window</span><span class="p">:</span>
        <span class="n">ff_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;extract:rt_window&quot;</span><span class="p">,</span>  <span class="n">rt_window</span><span class="p">)</span>
    <span class="n">ff_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;extract:n_isotopes&#39;</span><span class="p">,</span> <span class="n">n_isotopes</span><span class="p">)</span>
    <span class="n">ff_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;extract:isotope_pmin&#39;</span><span class="p">,</span> <span class="n">isotope_pmin</span><span class="p">)</span>
    <span class="n">ff_par</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;detect:peak_width&quot;</span><span class="p">,</span>  <span class="n">peak_width</span><span class="p">)</span>
    <span class="n">ff</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">ff_par</span><span class="p">)</span>
    
    <span class="c1"># run the FeatureFinderMetaboIdent with the metabo_table and mzML file path -&gt; store results in fm</span>
    <span class="n">ff</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">metab_table</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    
    <span class="n">feature_map</span><span class="o">.</span><span class="n">setUniqueIds</span><span class="p">()</span>  <span class="c1"># Assigns a new, valid unique id per feature</span>

    <span class="k">if</span> <span class="n">feature_filepath</span><span class="p">:</span>
        <span class="n">oms</span><span class="o">.</span><span class="n">FeatureXMLFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">feature_filepath</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">feature_map</span></div>


<div class="viewcode-block" id="targeted_feature_detection">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.targeted_feature_detection">[docs]</a>
<span class="k">def</span> <span class="nf">targeted_feature_detection</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">compound_library_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                               <span class="n">mz_window</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rt_window</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_isotopes</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">isotope_pmin</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                               <span class="n">peak_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span> <span class="n">mass_range</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="mf">50.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Feature detection with a given metabolic table with compund library file.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: Union[oms.MSExperiment, str]</span>
<span class="sd">    :param compound_library_file: Path to compound library file to define metabolic table from.</span>
<span class="sd">    :type compound_library_file: str</span>
<span class="sd">    :param metab_table: Metabilites table</span>
<span class="sd">    :type metab_table: list</span>
<span class="sd">    :param feature_filepath: Filpath to featureXML, defaults to None</span>
<span class="sd">    :type feature_filepath: Optional[str], optional</span>
<span class="sd">    :param mz_window: m/z window width, defaults to 5.0</span>
<span class="sd">    :type mz_window: float, optional</span>
<span class="sd">    :param rt_window: Retention time window width, defaults to None</span>
<span class="sd">    :type rt_window: Optional[float], optional</span>
<span class="sd">    :param n_isotopes: Number of considered isotopes, defaults to 2</span>
<span class="sd">    :type n_isotopes: int, optional</span>
<span class="sd">    :param isotope_pmin: Minimal probability of an isotope to be considered, defaults to 0.01</span>
<span class="sd">    :type isotope_pmin: float, optional</span>
<span class="sd">    :param peak_width: Standard peak width, defaults to 60.0</span>
<span class="sd">    :type peak_width: float, optional</span>
<span class="sd">    :return: Feature map</span>
<span class="sd">    :rtype: pyopenms.FeatureMap</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">experiment</span> <span class="o">=</span> <span class="n">load_experiment</span><span class="p">(</span><span class="n">experiment</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Defining metabolite table...&quot;</span><span class="p">)</span>
    <span class="n">metab_table</span> <span class="o">=</span> <span class="n">define_metabolite_table</span><span class="p">(</span><span class="n">compound_library_file</span><span class="p">,</span> <span class="n">mass_range</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metabolite table defined...&quot;</span><span class="p">)</span>
    
    <span class="n">feature_map</span> <span class="o">=</span> <span class="n">feature_detection_targeted</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment</span><span class="p">,</span> <span class="n">metab_table</span><span class="o">=</span><span class="n">metab_table</span><span class="p">,</span> 
                                             <span class="n">mz_window</span><span class="o">=</span><span class="n">mz_window</span><span class="p">,</span> <span class="n">rt_window</span><span class="o">=</span><span class="n">rt_window</span><span class="p">,</span> <span class="n">peak_width</span><span class="o">=</span><span class="n">peak_width</span><span class="p">,</span>
                                             <span class="n">n_isotopes</span><span class="o">=</span><span class="n">n_isotopes</span><span class="p">,</span> <span class="n">isotope_pmin</span><span class="o">=</span><span class="n">isotope_pmin</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Feature map created.&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">feature_map</span></div>



<div class="viewcode-block" id="targeted_features_detection">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.targeted_features_detection">[docs]</a>
<span class="k">def</span> <span class="nf">targeted_features_detection</span><span class="p">(</span><span class="n">in_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">run_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">file_ending</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">compound_library_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> 
                                <span class="n">mz_window</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">rt_window</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">n_isotopes</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">isotope_pmin</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span>
                                <span class="n">peak_width</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span> <span class="n">mass_range</span><span class="p">:</span><span class="nb">list</span><span class="o">=</span><span class="p">[</span><span class="mf">50.0</span><span class="p">,</span> <span class="mf">10000.0</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Feature detection with a given metabolic table with compund library file.</span>

<span class="sd">    :param in_dir: Input directory</span>
<span class="sd">    :type in_dir: str</span>
<span class="sd">    :param run_dir: Run directory</span>
<span class="sd">    :type run_dir: str</span>
<span class="sd">    :param file_ending: File ending</span>
<span class="sd">    :type file_ending: str</span>
<span class="sd">    :param compound_library_file: Path to compound library file to define metabolic table from.</span>
<span class="sd">    :type compound_library_file: str</span>
<span class="sd">    :param metab_table: Metabilites table</span>
<span class="sd">    :type metab_table: list</span>
<span class="sd">    :param feature_filepath: Filpath to featureXML, defaults to None</span>
<span class="sd">    :type feature_filepath: Optional[str], optional</span>
<span class="sd">    :param mz_window: m/z window width, defaults to 5.0</span>
<span class="sd">    :type mz_window: float, optional</span>
<span class="sd">    :param rt_window: Retention time window width, defaults to None</span>
<span class="sd">    :type rt_window: Optional[float], optional</span>
<span class="sd">    :param n_isotopes: Number of considered isotopes, defaults to 2</span>
<span class="sd">    :type n_isotopes: int, optional</span>
<span class="sd">    :param isotope_pmin: Minimal probability of an isotope to be considered, defaults to 0.01</span>
<span class="sd">    :type isotope_pmin: float, optional</span>
<span class="sd">    :param peak_width: Standard peak width, defaults to 60.0</span>
<span class="sd">    :type peak_width: float, optional</span>
<span class="sd">    :return: List of feature maps</span>
<span class="sd">    :rtype: list[pyopenms.FeatureMap]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Defining metabolite table...&quot;</span><span class="p">)</span>
    <span class="n">metab_table</span> <span class="o">=</span> <span class="n">define_metabolite_table</span><span class="p">(</span><span class="n">compound_library_file</span><span class="p">,</span> <span class="n">mass_range</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Metabolite table defined...&quot;</span><span class="p">)</span>

    <span class="n">feature_folder</span> <span class="o">=</span> <span class="n">clean_dir</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="s2">&quot;features_targeted&quot;</span><span class="p">)</span>
    <span class="n">feature_maps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">in_dir</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">file_ending</span><span class="p">):</span>
            <span class="n">experiment_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">feature_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">feature_folder</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">file</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">file_ending</span><span class="p">)]</span><span class="si">}</span><span class="s2">.featureXML&quot;</span><span class="p">)</span>
            <span class="n">feature_map</span> <span class="o">=</span> <span class="n">feature_detection_targeted</span><span class="p">(</span><span class="n">experiment</span><span class="o">=</span><span class="n">experiment_file</span><span class="p">,</span> <span class="n">metab_table</span><span class="o">=</span><span class="n">metab_table</span><span class="p">,</span> <span class="n">feature_filepath</span><span class="o">=</span><span class="n">feature_filepath</span><span class="p">,</span>
                                                     <span class="n">mz_window</span><span class="o">=</span><span class="n">mz_window</span><span class="p">,</span> <span class="n">rt_window</span><span class="o">=</span><span class="n">rt_window</span><span class="p">,</span> <span class="n">n_isotopes</span><span class="o">=</span><span class="n">n_isotopes</span><span class="p">,</span>
                                                     <span class="n">isotope_pmin</span><span class="o">=</span><span class="n">isotope_pmin</span><span class="p">,</span> <span class="n">peak_width</span><span class="o">=</span><span class="n">peak_width</span><span class="p">)</span>
            <span class="n">feature_maps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_map</span><span class="p">)</span>
          
    <span class="k">return</span> <span class="n">feature_maps</span></div>




<span class="c1">## Clustering</span>
<div class="viewcode-block" id="extract_from_clustering">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.extract_from_clustering">[docs]</a>
<span class="k">def</span> <span class="nf">extract_from_clustering</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">clustering</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract mzs and intensities from clustering</span>

<span class="sd">    :param df: Input dataframe</span>
<span class="sd">    :type df: pandas.DataFrame</span>
<span class="sd">    :param clustering: Clustering</span>
<span class="sd">    :type clustering: np.ndarray</span>
<span class="sd">    :return: m/z + inty as paired array</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mzs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">intys</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">clustering</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">clustering</span> <span class="o">==</span> <span class="n">c</span>
        <span class="n">intys_clust</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;inty&quot;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mzs_clust</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">][</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">inty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intys_clust</span><span class="p">)</span>
        <span class="n">mz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mzs_clust</span> <span class="o">*</span> <span class="n">intys_clust</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intys_clust</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">mzs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mz</span><span class="p">)</span>
        <span class="n">intys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inty</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span> <span class="p">[</span><span class="n">mzs</span><span class="p">,</span> <span class="n">intys</span><span class="p">]</span> <span class="p">)</span>    </div>



<div class="viewcode-block" id="cluster_matlab">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.cluster_matlab">[docs]</a>
<span class="k">def</span> <span class="nf">cluster_matlab</span><span class="p">(</span><span class="n">df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">height_lim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">prominence_lim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="p">(</span><span class="mf">7e-2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clusters according to FIA matlab routine</span>

<span class="sd">    :param df: Input dataframe</span>
<span class="sd">    :type df: pd.DataFrame</span>
<span class="sd">    :param height_lim: height limit, defaults to 1000</span>
<span class="sd">    :type height_lim: int, optional</span>
<span class="sd">    :param prominence_lim: prominence limit, defaults to 1000</span>
<span class="sd">    :type prominence_lim: int, optional</span>
<span class="sd">    :param threshold: threshold to cut off values, defaults to (7e-2)**2</span>
<span class="sd">    :type threshold: float, optional</span>
<span class="sd">    :return: m/z + inty as paired array</span>
<span class="sd">    :rtype: np.ndarray</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Peak detection</span>
    <span class="n">peaks</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;inty&quot;</span><span class="p">],</span> <span class="n">height</span><span class="o">=</span><span class="n">height_lim</span><span class="p">,</span> <span class="n">prominence</span><span class="o">=</span><span class="n">prominence_lim</span><span class="p">)</span>    <span class="c1"># type: ignore</span>
    <span class="n">peaked_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">peaks</span><span class="p">]]</span>

    <span class="c1"># Distance calculation @(x,y) (x(:,1)-y(:,1)).^2  + (x(:,2)==y(:,2))*10^6; </span>
    <span class="n">distances</span> <span class="o">=</span> <span class="n">pdist</span><span class="p">(</span><span class="n">peaked_df</span><span class="p">[</span><span class="s2">&quot;mz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;cityblock&quot;</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pdist</span><span class="p">(</span><span class="n">peaked_df</span><span class="p">[</span><span class="s2">&quot;RT&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">metric</span><span class="o">=</span><span class="s2">&quot;hamming&quot;</span><span class="p">)</span><span class="o">*</span><span class="mf">1e6</span>  <span class="c1"># type: ignore  </span>
    <span class="n">tree</span> <span class="o">=</span> <span class="n">linkage</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span>
    <span class="n">clustering</span> <span class="o">=</span>  <span class="n">fcluster</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">criterion</span><span class="o">=</span><span class="s2">&quot;distance&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extract_from_clustering</span><span class="p">(</span><span class="n">peaked_df</span><span class="p">,</span> <span class="n">clustering</span><span class="p">)</span></div>



<div class="viewcode-block" id="cluster_sliding_window">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.cluster_sliding_window">[docs]</a>
<span class="k">def</span> <span class="nf">cluster_sliding_window</span><span class="p">(</span><span class="n">comb_experiment</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="n">height_lim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">prominence_lim</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">window_len</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                           <span class="n">window_shift</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="p">(</span><span class="mf">7e-2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Applies clustering over sliding window in an experiment. The result may contain duplicates or close to duplicates.</span>

<span class="sd">    :param comb_experiment: Input experiment</span>
<span class="sd">    :type comb_experiment: pyopenms.MSExperiment</span>
<span class="sd">    param height_lim: height limit, defaults to 1000</span>
<span class="sd">    :type height_lim: int, optional</span>
<span class="sd">    :param prominence_lim: prominence limit, defaults to 1000</span>
<span class="sd">    :type prominence_lim: int, optional</span>
<span class="sd">    :param window_len: Window length, defaults to 2000</span>
<span class="sd">    :type window_len: int, optional</span>
<span class="sd">    :param window_shift: Window shift, defaults to 1000</span>
<span class="sd">    :type window_shift: int, optional</span>
<span class="sd">    :param threshold: threshold to cut off values, defaults to (7e-2)**2</span>
<span class="sd">    :type threshold: float, optional</span>
<span class="sd">    :return: Clustered experiment</span>
<span class="sd">    :rtype: pyopenms.MSExperiment</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">comb_experiment</span><span class="o">.</span><span class="n">getSpectra</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">comb_experiment</span><span class="o">.</span><span class="n">get_df</span><span class="p">(</span><span class="n">long</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">-</span> <span class="n">window_len</span><span class="p">,</span> <span class="n">window_shift</span><span class="p">)):</span>
        <span class="n">clust_exp</span> <span class="o">=</span> <span class="n">cluster_matlab</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">window_len</span><span class="p">],</span> <span class="n">height_lim</span><span class="o">=</span><span class="n">height_lim</span><span class="p">,</span> <span class="n">prominence_lim</span><span class="o">=</span><span class="n">prominence_lim</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
        <span class="n">peaks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clust_exp</span><span class="p">)</span>
    <span class="n">clust_exp</span> <span class="o">=</span> <span class="n">cluster_matlab</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="n">window_len</span><span class="p">:</span><span class="n">n</span><span class="p">],</span> <span class="n">height_lim</span><span class="o">=</span><span class="n">height_lim</span><span class="p">,</span> <span class="n">prominence_lim</span><span class="o">=</span><span class="n">prominence_lim</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">(</span><span class="n">peaks</span><span class="p">)</span>
    <span class="n">peaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">peaks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Packaging</span>
    <span class="n">clustered_experiment</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">()</span>
    <span class="n">clustered_spectrum</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">()</span>
    <span class="n">clustered_spectrum</span><span class="o">.</span><span class="n">set_peaks</span><span class="p">((</span><span class="n">peaks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">peaks</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>         <span class="c1"># type: ignore</span>
    <span class="n">clustered_experiment</span><span class="o">.</span><span class="n">addSpectrum</span><span class="p">(</span><span class="n">clustered_spectrum</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">clustered_experiment</span></div>




<span class="c1">## Label assigning</span>
<span class="c1">### Accurate Mass</span>
<div class="viewcode-block" id="accurate_mass_search">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.accurate_mass_search">[docs]</a>
<span class="k">def</span> <span class="nf">accurate_mass_search</span><span class="p">(</span><span class="n">consensus_map</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">ConsensusMap</span><span class="p">,</span> <span class="n">database_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">tmp_dir</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                         <span class="n">positive_adducts_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">negative_adducts_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> 
                         <span class="n">HMDBMapping_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">HMDB2StructMapping_file</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
                         <span class="n">ionization_mode</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;auto&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Assigning metbolites to consensus map masses.</span>

<span class="sd">    :param consensus_map: Input consensus map</span>
<span class="sd">    :type consensus_map: pyopenms.ConsensusMap</span>
<span class="sd">    :param database_dir: Database directory</span>
<span class="sd">    :type database_dir: str</span>
<span class="sd">    :param tmp_dir: Directory for temporary saves</span>
<span class="sd">    :type tmp_dir: str</span>
<span class="sd">    :param positive_adducts_file: File with possible positive adducts</span>
<span class="sd">    :type positive_adducts_file: str</span>
<span class="sd">    :param negative_adducts_file: File with possible negative adducts</span>
<span class="sd">    :type negative_adducts_file: str</span>
<span class="sd">    :param HMDBMapping_file: HMDBMapping file</span>
<span class="sd">    :type HMDBMapping_file: str</span>
<span class="sd">    :param HMDB2StructMapping_file: HMDB2StructMapping file</span>
<span class="sd">    :type HMDB2StructMapping_file: str</span>
<span class="sd">    :param ionization_mode: Ionization mode, defaults to &quot;auto&quot;</span>
<span class="sd">    :type ionization_mode: str, optional</span>
<span class="sd">    :return: Annotated dataframe</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">clean_dir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>

    <span class="n">ams</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">AccurateMassSearchEngine</span><span class="p">()</span>

    <span class="n">ams_params</span> <span class="o">=</span> <span class="n">ams</span><span class="o">.</span><span class="n">getParameters</span><span class="p">()</span>
    <span class="n">ams_params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;ionization_mode&quot;</span><span class="p">,</span> <span class="n">ionization_mode</span><span class="p">)</span>
    <span class="n">ams_params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;positive_adducts&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">database_dir</span><span class="p">,</span> <span class="n">positive_adducts_file</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">ams_params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;negative_adducts&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">database_dir</span><span class="p">,</span> <span class="n">negative_adducts_file</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">ams_params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;db:mapping&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">database_dir</span><span class="p">,</span> <span class="n">HMDBMapping_file</span><span class="p">)]</span> <span class="p">)</span>
    <span class="n">ams_params</span><span class="o">.</span><span class="n">setValue</span><span class="p">(</span> <span class="s2">&quot;db:struct&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">database_dir</span><span class="p">,</span> <span class="n">HMDB2StructMapping_file</span><span class="p">)]</span> <span class="p">)</span>
    <span class="n">ams</span><span class="o">.</span><span class="n">setParameters</span><span class="p">(</span><span class="n">ams_params</span><span class="p">)</span>

    <span class="n">mztab</span> <span class="o">=</span> <span class="n">oms</span><span class="o">.</span><span class="n">MzTab</span><span class="p">()</span>
    <span class="n">ams</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>

    <span class="n">ams</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">consensus_map</span><span class="p">,</span> <span class="n">mztab</span><span class="p">)</span>

    <span class="n">oms</span><span class="o">.</span><span class="n">MzTabFile</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;ids.tsv&quot;</span><span class="p">),</span> <span class="n">mztab</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;ids_smsection.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;w&quot;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;ids.tsv&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span> <span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;SM&quot;</span><span class="p">):</span>
                <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">4</span><span class="p">:])</span>

    <span class="n">ams_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s2">&quot;ids_smsection.tsv&quot;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ams_df</span></div>




<span class="c1"># Transformation to DataFrame</span>
<div class="viewcode-block" id="consensus_map_to_df">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.consensus_map_to_df">[docs]</a>
<span class="k">def</span> <span class="nf">consensus_map_to_df</span><span class="p">(</span><span class="n">consensus_map</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">ConsensusMap</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Transforms a consensus map into a daraframe</span>

<span class="sd">    :param consensus_map: Input consensus map</span>
<span class="sd">    :type consensus_map: pyopenms.ConsensusMap</span>
<span class="sd">    :return: Dataframe from consensus map</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">intensities</span> <span class="o">=</span> <span class="n">consensus_map</span><span class="o">.</span><span class="n">get_intensity_df</span><span class="p">()</span>
    <span class="n">meta_data</span> <span class="o">=</span> <span class="n">consensus_map</span><span class="o">.</span><span class="n">get_metadata_df</span><span class="p">()[[</span><span class="s2">&quot;RT&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;quality&quot;</span><span class="p">]]</span>

    <span class="n">cm_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">meta_data</span><span class="p">,</span> <span class="n">intensities</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cm_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cm_df</span> </div>



<span class="c1"># Consensus map filtering</span>
<div class="viewcode-block" id="filter_consensus_map_df">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.filter_consensus_map_df">[docs]</a>
<span class="k">def</span> <span class="nf">filter_consensus_map_df</span><span class="p">(</span><span class="n">consensus_map_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">max_missing_values</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">min_feature_quality</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter consensus map DataFrame according to missing values and feature quality.</span>

<span class="sd">    :param consensus_map_df: Input consensus map dataframe</span>
<span class="sd">    :type consensus_map_df: pandas.DataFrame</span>
<span class="sd">    :param max_missing_values: Maximum number of missing values, defaults to 1</span>
<span class="sd">    :type max_missing_values: int, optional</span>
<span class="sd">    :param min_feature_quality: Minimal quality of feature, defaults to 0.8</span>
<span class="sd">    :type min_feature_quality: Optional[float], optional</span>
<span class="sd">    :return: Filtered consensus map dataframe</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">to_drop</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cm_df</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">consensus_map_df</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cm_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">row</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">max_missing_values</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">min_feature_quality</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;quality&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">min_feature_quality</span><span class="p">:</span>
                    <span class="n">to_drop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="n">cm_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">cm_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">to_drop</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cm_df</span></div>



<span class="c1"># Consensus map imputation</span>
<div class="viewcode-block" id="impute_consensus_map_df">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.impute_consensus_map_df">[docs]</a>
<span class="k">def</span> <span class="nf">impute_consensus_map_df</span><span class="p">(</span><span class="n">consensus_map_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">n_nearest_neighbours</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Data imputation with k-neares-neighbours (kNN).</span>

<span class="sd">    :param consensus_map_df: Input consensus map dataframe</span>
<span class="sd">    :type consensus_map_df: pandas.DataFrame</span>
<span class="sd">    :param n_nearest_neighbours: K nearest neighbours, defaults to 2</span>
<span class="sd">    :type n_nearest_neighbours: int, optional</span>
<span class="sd">    :return: Consensus map dataframe with imputed values</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">consensus_map_df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">imputer</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span> <span class="s2">&quot;imputer&quot;</span><span class="p">,</span> <span class="n">KNNImputer</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">n_nearest_neighbours</span><span class="p">)),</span>
                <span class="p">(</span> <span class="s2">&quot;pandarizer&quot;</span><span class="p">,</span> <span class="n">FunctionTransformer</span><span class="p">(</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">consensus_map_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">consensus_map_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">imputer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">consensus_map_df</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">consensus_map_df</span></div>



<span class="c1"># Merging</span>
<div class="viewcode-block" id="find_close">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.find_close">[docs]</a>
<span class="k">def</span> <span class="nf">find_close</span><span class="p">(</span><span class="n">df1</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df1_col</span><span class="p">,</span> <span class="n">df2</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">df2_col</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find close values in two dataframes.</span>

<span class="sd">    :param df1: Input dataframe 1</span>
<span class="sd">    :type df1: pandas.DataFrame</span>
<span class="sd">    :param df1_col: Input dataframe 1 matched column</span>
<span class="sd">    :type df1_col: all</span>
<span class="sd">    :param df2: Input dataframe 2</span>
<span class="sd">    :type df2: pandas.DataFrame</span>
<span class="sd">    :param df2_col: Input dataframe 2 matched column</span>
<span class="sd">    :type df2_col: all</span>
<span class="sd">    :param tolerance: Absolute tolerance in difference, defaults to 0.001</span>
<span class="sd">    :type tolerance: float, optional</span>
<span class="sd">    :yield: Datframe of close values</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">df1</span><span class="p">[</span><span class="n">df1_col</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">df2</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">df2</span><span class="p">[</span><span class="n">df2_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tolerance</span><span class="p">)]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;idx1&#39;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s1">&#39;idx2&#39;</span><span class="p">:</span> <span class="n">indices</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>
        <span class="k">yield</span> <span class="n">s</span></div>



<div class="viewcode-block" id="merge_by_mz">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.merge_by_mz">[docs]</a>
<span class="k">def</span> <span class="nf">merge_by_mz</span><span class="p">(</span><span class="n">id_df_1</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">id_df_2</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">mz_tolerance</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1e-04</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Merge dataframes by mz column.</span>

<span class="sd">    :param id_df_1: Input dataframe 1</span>
<span class="sd">    :type id_df_1: pandas.DataFrame</span>
<span class="sd">    :param id_df_2: Input dataframe 2</span>
<span class="sd">    :type id_df_2: pandas.DataFrame</span>
<span class="sd">    :param mz_tolerance: Tolerance of m/z deviation, defaults to 1e-04</span>
<span class="sd">    :type mz_tolerance: float, optional</span>
<span class="sd">    :return: _description_</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">id_df</span> <span class="o">=</span> <span class="n">id_df_1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">df_idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">find_close</span><span class="p">(</span><span class="n">id_df_1</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">id_df_2</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="n">mz_tolerance</span><span class="p">),</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_idx</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">id_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;idx1&quot;</span><span class="p">],</span> <span class="s2">&quot;centroided_intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">id_df_1</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;idx1&quot;</span><span class="p">],</span> <span class="s2">&quot;centroided_intensity&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">id_df_2</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;idx2&quot;</span><span class="p">],</span> <span class="s2">&quot;centroided_intensity&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">not_merged</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">id_df_2</span><span class="o">.</span><span class="n">index</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_idx</span><span class="p">[</span><span class="s2">&quot;idx2&quot;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">id_df</span><span class="p">,</span> <span class="n">id_df_2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">not_merged</span><span class="p">]])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>




<span class="c1"># Printing</span>
<div class="viewcode-block" id="print_params">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.print_params">[docs]</a>
<span class="k">def</span> <span class="nf">print_params</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print parameters of pyopenms class.</span>

<span class="sd">    :param p: Parameters</span>
<span class="sd">    :type p: dict-like</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;Param:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Value:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;Description:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">getDescription</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;no data available&quot;</span><span class="p">)</span></div>




<span class="c1">### Plotting ###</span>
<div class="viewcode-block" id="quick_plot">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.quick_plot">[docs]</a>
<span class="k">def</span> <span class="nf">quick_plot</span><span class="p">(</span><span class="n">spectrum</span><span class="p">:</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSSpectrum</span><span class="p">,</span> <span class="n">xlim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">plottype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[])</span> <span class="o">-&gt;</span> <span class="n">Figure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shows a plot of a spectrum between the defined borders</span>

<span class="sd">    :param spectrum: Input spectrum</span>
<span class="sd">    :type spectrum: pyopenms.MSSpectrum</span>
<span class="sd">    :param xlim: x-axis limits, defaults to None</span>
<span class="sd">    :type xlim: Optional[List[float]], optional</span>
<span class="sd">    :param ylim: y-axis limits, defaults to None</span>
<span class="sd">    :type ylim: Optional[List[float]], optional</span>
<span class="sd">    :param plottype: Type of plot [line|scatter], defaults to &quot;line&quot;</span>
<span class="sd">    :type plottype: str, optional</span>
<span class="sd">    :param log: Axes to log-transform [x,y], defaults to []</span>
<span class="sd">    :type log: List[str], optional</span>
<span class="sd">    :return: Figure</span>
<span class="sd">    :rtype: Figure</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;scatter&quot;</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sizes</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span></div>



<div class="viewcode-block" id="sns_plot">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.sns_plot">[docs]</a>
<span class="k">def</span> <span class="nf">sns_plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xlim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">ylim</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">plottype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[],</span> <span class="n">sizes</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">),</span> <span class="n">palette</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;hls&quot;</span><span class="p">,</span>
            <span class="n">figsize</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shows a plot of a spectrum between the defined borders.</span>

<span class="sd">    :param x: x-values</span>
<span class="sd">    :type x: array-like</span>
<span class="sd">    :param y: x-values</span>
<span class="sd">    :type y: array-like</span>
<span class="sd">    :param hue: Column to group x and y values, defaults to None</span>
<span class="sd">    :type hue: all, optional</span>
<span class="sd">    :param size: Size of elements, defaults to None</span>
<span class="sd">    :type size: float, optional</span>
<span class="sd">    :param xlim: x-axis limits, defaults to None</span>
<span class="sd">    :type xlim: Optional[List[float]], optional</span>
<span class="sd">    :param ylim: y-axis limits, defaults to None</span>
<span class="sd">    :type ylim: Optional[List[float]], optional</span>
<span class="sd">    :param plottype: Type of plot [line|scatter], defaults to &quot;line&quot;</span>
<span class="sd">    :type plottype: str, optional</span>
<span class="sd">    :param log: Axes to log-transform [x,y], defaults to []</span>
<span class="sd">    :type log: List[str], optional</span>
<span class="sd">    :param sizes: Sizes of points in relation to y-value, defaults to (20,20)</span>
<span class="sd">    :type sizes: Optional[Tuple[int, int]], optional</span>
<span class="sd">    :param palette: Color palette, defaults to &quot;hls&quot;</span>
<span class="sd">    :type palette: str, optional</span>
<span class="sd">    :param figsize: Figure size, defaults to (18, 5)</span>
<span class="sd">    :type figsize: Optional[Tuple[int,int]], optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> <span class="c1"># type: ignore</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;scatter&quot;</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="n">hue</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">sizes</span><span class="o">=</span><span class="n">sizes</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">palette</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

    <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xlim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>




<div class="viewcode-block" id="dynamic_plot">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.dynamic_plot">[docs]</a>
<span class="k">def</span> <span class="nf">dynamic_plot</span><span class="p">(</span><span class="n">experiment</span><span class="p">:</span> <span class="n">oms</span><span class="o">.</span><span class="n">MSExperiment</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="n">log</span><span class="p">:</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Shows an interactive plot of all spectra in the experiment. May take a long time for large datasets.</span>
<span class="sd">    Recommended after centroiding, or data reduction.</span>

<span class="sd">    :param experiment: Input experiment</span>
<span class="sd">    :type experiment: pyopenms.MSExperiment</span>
<span class="sd">    :param mode: Mode of display [&quot;lines&quot; | &quot;markers&quot; | &quot;lines+markers&quot; | other pyplot.graph_objects options], defaults to &quot;lines&quot;</span>
<span class="sd">    :type mode: str, optional</span>
<span class="sd">    :param log: Axes to log-transform [x,y], defaults to []</span>
<span class="sd">    :type log: List[str], optional</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">spectrum</span> <span class="ow">in</span> <span class="n">experiment</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">y</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="n">spectrum</span><span class="o">.</span><span class="n">getRT</span><span class="p">())</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;y&quot;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;x&quot;</span> <span class="ow">in</span> <span class="n">log</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_xaxes</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Superplot MSExperiment&#39;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>



<div class="viewcode-block" id="plot_mass_traces">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.plot_mass_traces">[docs]</a>
<span class="k">def</span> <span class="nf">plot_mass_traces</span><span class="p">(</span><span class="n">mass_traces</span><span class="p">,</span> <span class="n">sel</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">100</span><span class="p">],</span> <span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="n">threed</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot mass traces along 3d plot.</span>

<span class="sd">    :param mass_traces: List of mass traces</span>
<span class="sd">    :type mass_traces: list</span>
<span class="sd">    :param sel: Selection of convex hull points, defaults to [0,100]</span>
<span class="sd">    :type sel: list, optional</span>
<span class="sd">    :param x: x-axis column, defaults to &quot;rt&quot;</span>
<span class="sd">    :type x: str, optional</span>
<span class="sd">    :param y: y-axis column, defaults to &quot;mz&quot;</span>
<span class="sd">    :type y: str, optional</span>
<span class="sd">    :param z: z-axis column, defaults to &quot;int&quot;</span>
<span class="sd">    :type z: str, optional</span>
<span class="sd">    :param threed: 3D plot, defaults to True</span>
<span class="sd">    :type threed: bool, optional</span>
<span class="sd">    :return: Plot</span>
<span class="sd">    :rtype: plotly-express plot</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">dfs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">sel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sel</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">peak</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mass_traces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getConvexhull</span><span class="p">()</span><span class="o">.</span><span class="n">getHullPoints</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">mass_traces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getConvexhull</span><span class="p">()</span><span class="o">.</span><span class="n">getHullPoints</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="n">peak</span><span class="p">)]</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mass_traces</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getSmoothedIntensities</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">hp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">hp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="s2">&quot;int&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">]))</span>
    <span class="n">ch_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">threed</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">px</span><span class="o">.</span><span class="n">line_3d</span><span class="p">(</span><span class="n">ch_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">ch_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">hover_data</span><span class="o">=</span><span class="n">z</span><span class="p">)</span></div>



<div class="viewcode-block" id="plot_feature_map_rt_alignment">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.plot_feature_map_rt_alignment">[docs]</a>
<span class="k">def</span> <span class="nf">plot_feature_map_rt_alignment</span><span class="p">(</span><span class="n">ordered_feature_maps</span><span class="p">:</span><span class="nb">list</span><span class="p">,</span> <span class="n">legend</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot feature map retention time alignment</span>

<span class="sd">    :param ordered_feature_maps: Listof feature maps</span>
<span class="sd">    :type ordered_feature_maps: list</span>
<span class="sd">    :param legend: Display legend, defaults to False</span>
<span class="sd">    :type legend: bool, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;consensus map before alignment&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;m/z&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;RT&quot;</span><span class="p">)</span>

    <span class="c1"># use alpha value to display feature intensity</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">getRT</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">getMZ</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="o">/</span> <span class="nb">max</span><span class="p">([</span><span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]]),</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;original_RT&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">],</span>
            <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">getMZ</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">])</span>
            <span class="o">/</span> <span class="nb">max</span><span class="p">([</span><span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;consensus map after alignment&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;RT&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
            <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">getRT</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">],</span>
            <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">getMZ</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">],</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">])</span>
            <span class="o">/</span> <span class="nb">max</span><span class="p">([</span><span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">()</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">fm</span><span class="p">]),</span>
        <span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">fm</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;spectra_data&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span> <span class="k">for</span> <span class="n">fm</span> <span class="ow">in</span> <span class="n">ordered_feature_maps</span><span class="p">],</span>
            <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower center&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="extract_feature_coord">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.extract_feature_coord">[docs]</a>
<span class="k">def</span> <span class="nf">extract_feature_coord</span><span class="p">(</span><span class="n">feature</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">Feature</span><span class="p">,</span> <span class="n">mzs</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">retention_times</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">intensities</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">labels</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sub_feat</span><span class="p">:</span><span class="n">Optional</span><span class="p">[</span><span class="n">oms</span><span class="o">.</span><span class="n">Feature</span><span class="p">]</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract feature coordinates for plots</span>

<span class="sd">    :param feature: Input feature</span>
<span class="sd">    :type feature: oms.Feature</span>
<span class="sd">    :param mzs: m/z values</span>
<span class="sd">    :type mzs: np.ndarray</span>
<span class="sd">    :param retention_times: Retention times</span>
<span class="sd">    :type retention_times: np.ndarray</span>
<span class="sd">    :param intensities: Intensity values</span>
<span class="sd">    :type intensities: np.ndarray</span>
<span class="sd">    :param labels: Labels</span>
<span class="sd">    :type labels: np.ndarray</span>
<span class="sd">    :param sub_feat: Sub-features, defaults to None</span>
<span class="sd">    :type sub_feat: Optional[oms.Feature], optional</span>
<span class="sd">    :return: List of mzs, retention times intensities and matching labels for plots</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="k">if</span> <span class="n">sub_feat</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">hull_point</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_feat</span><span class="o">.</span><span class="n">getConvexHulls</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">getHullPoints</span><span class="p">()):</span>
            <span class="n">mzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">sub_feat</span><span class="o">.</span><span class="n">getMZ</span><span class="p">())</span>
            <span class="n">retention_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">retention_times</span><span class="p">,</span> <span class="n">hull_point</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensities</span><span class="p">,</span> <span class="n">hull_point</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="n">mzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mzs</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">getMZ</span><span class="p">())</span>
        <span class="n">retention_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">retention_times</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">getRT</span><span class="p">())</span>
        <span class="n">intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensities</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">getIntensity</span><span class="p">())</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">getMetaValue</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="p">[</span><span class="n">mzs</span><span class="p">,</span> <span class="n">retention_times</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">labels</span><span class="p">]</span></div>



<div class="viewcode-block" id="plot_features_3D">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.plot_features_3D">[docs]</a>
<span class="k">def</span> <span class="nf">plot_features_3D</span><span class="p">(</span><span class="n">feature_map</span><span class="p">:</span><span class="n">oms</span><span class="o">.</span><span class="n">FeatureMap</span><span class="p">,</span> <span class="n">plottype</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;scatter&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents found features in 3D</span>

<span class="sd">    :param feature_map: Input feature map</span>
<span class="sd">    :type feature_map: oms.FeatureMap</span>
<span class="sd">    :param plottype: Type of plot [scatter|surface|line], defaults to &quot;scatter&quot;</span>
<span class="sd">    :type plottype: str, optional</span>
<span class="sd">    :raises ValueError: Use [&#39;surface&#39;,&#39;scatter&#39;,&#39;line&#39;]</span>
<span class="sd">    :return: Dataframe with 3d features</span>
<span class="sd">    :rtype: pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mzs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">retention_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_map</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">getSubordinates</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub_feat</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">getSubordinates</span><span class="p">()):</span>
                <span class="n">mzs</span><span class="p">,</span> <span class="n">retention_times</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">extract_feature_coord</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">mzs</span><span class="p">,</span> <span class="n">retention_times</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">sub_feat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mzs</span><span class="p">,</span> <span class="n">retention_times</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">extract_feature_coord</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">mzs</span><span class="p">,</span> <span class="n">retention_times</span><span class="p">,</span> <span class="n">intensities</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;m/z&quot;</span><span class="p">:</span> <span class="n">mzs</span><span class="p">,</span> <span class="s2">&quot;rt&quot;</span><span class="p">:</span> <span class="n">retention_times</span><span class="p">,</span> <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="n">intensities</span><span class="p">,</span> <span class="s2">&quot;labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">})</span>
    
    <span class="k">if</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;surface&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">go</span><span class="o">.</span><span class="n">Surface</span><span class="p">(</span><span class="n">z</span><span class="o">=</span><span class="n">df</span><span class="p">)])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;3D plot of features&#39;</span><span class="p">,</span> <span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                    <span class="n">xaxis_title</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span>
                    <span class="n">margin</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="mi">65</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="mi">90</span><span class="p">),</span>
                    <span class="n">scene</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;aspectratio&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
                            <span class="p">})</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;line&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line_3d</span><span class="p">(</span><span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;labels&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">plottype</span> <span class="o">==</span> <span class="s2">&quot;scatter&quot;</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_3d</span><span class="p">(</span><span class="n">data_frame</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;m/z&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;rt&quot;</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="s2">&quot;intensity&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;labels&quot;</span><span class="p">,</span> <span class="n">size_max</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">plottype</span><span class="si">}</span><span class="s2"> is not a valid type of plot. Use [&#39;surface&#39;,&#39;scatter&#39;,&#39;line&#39;]&quot;</span><span class="p">)</span>
 
    <span class="k">if</span> <span class="n">plottype</span><span class="p">:</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_traces</span><span class="p">(</span><span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>        
        <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="plot_id_df">
<a class="viewcode-back" href="../../../skripts.FIA.html#skripts.FIA.FIA.plot_id_df">[docs]</a>
<span class="k">def</span> <span class="nf">plot_id_df</span><span class="p">(</span><span class="n">id_df</span><span class="p">:</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;RT&quot;</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;mz&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Scatterplot dataframe with identified metabolites.</span>

<span class="sd">    :param id_df: Input dataframe</span>
<span class="sd">    :type id_df: pd.DataFrame</span>
<span class="sd">    :param x: x-axis, defaults to &quot;RT&quot;</span>
<span class="sd">    :type x: str, optional</span>
<span class="sd">    :param y: y-axis, defaults to &quot;mz&quot;</span>
<span class="sd">    :type y: str, optional</span>
<span class="sd">    &quot;&quot;&quot;</span>    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">id_df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;RT&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;mz&quot;</span><span class="p">,</span> <span class="n">hover_name</span><span class="o">=</span><span class="s2">&quot;identifications&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Consensus features with identifications (hover)&quot;</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Josua Carl.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>